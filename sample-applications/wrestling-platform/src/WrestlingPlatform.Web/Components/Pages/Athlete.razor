@page "/athlete"
@inject PlatformApiClient ApiClient
@inject WorkflowState Workflow

<PageTitle>Athlete Portal - PinPoint Arena</PageTitle>

<div class="page-head">
    <div>
        <h1 class="page-title">Athlete Portal</h1>
        <p class="page-subtitle">Create your account, build your profile, discover events, register as team-affiliated or free-agent, and track rankings/history.</p>
    </div>
    <div class="tag-row">
        <span class="tag">Profile Builder</span>
        <span class="tag">Fast Event Entry</span>
        <span class="tag">Notification Control</span>
    </div>
</div>

<section class="panel">
    <h3>Workflow Shortcuts</h3>
    <div class="actions spacer-top">
        <button class="btn ghost" @onclick="UseDemoAthleteCredentials">Use Demo Athlete Credentials</button>
        <button class="btn ghost" @onclick="ApplyWorkflowContext">Apply Workflow IDs</button>
        <button class="btn ghost" @onclick="LoadLatestEventAsync" disabled="@IsBusy">Find Latest Event</button>
    </div>
    <p class="helper spacer-top">Workflow athlete id: <span class="mono">@Short(Workflow.AthleteProfileId)</span> | workflow event id: <span class="mono">@Short(Workflow.EventId)</span></p>
</section>

<div class="panel-grid two">
    <section class="panel">
        <h2>1) Athlete Account</h2>
        <div class="form-grid spacer-top">
            <div class="field">
                <label>Email</label>
                <input class="input" @bind="AccountEmail" />
            </div>
            <div class="field">
                <label>Password</label>
                <input class="input" type="password" @bind="AccountPassword" />
            </div>
            <div class="field">
                <label>Phone</label>
                <input class="input" @bind="AccountPhone" placeholder="+1..." />
            </div>
        </div>
        <div class="actions">
            <button class="btn primary" @onclick="RegisterUserAsync" disabled="@IsBusy">Create Athlete User</button>
        </div>
        @if (!string.IsNullOrWhiteSpace(AccountMessage))
        {
            <div class="alert @(AccountSuccess ? "success" : "error")">@AccountMessage</div>
        }
        @if (CreatedUserId is not null)
        {
            <p class="helper spacer-top">Created user id: <span class="mono">@CreatedUserId</span></p>
        }

        <hr class="soft" />

        <h3>2) Athlete Profile</h3>
        <div class="form-grid spacer-top">
            <div class="field">
                <label>User Id</label>
                <input class="input mono" @bind="ProfileUserId" />
            </div>
            <div class="field">
                <label>First Name</label>
                <input class="input" @bind="FirstName" />
            </div>
            <div class="field">
                <label>Last Name</label>
                <input class="input" @bind="LastName" />
            </div>
            <div class="field">
                <label>Date Of Birth</label>
                <input class="input" type="text" placeholder="YYYY-MM-DD" @bind="BirthDateText" />
            </div>
            <div class="field">
                <label>State</label>
                <select class="select" @bind="State">
                    @foreach (var state in FormOptions.UsStates)
                    {
                        <option value="@state.Code">@state.Name</option>
                    }
                </select>
            </div>
            <div class="field">
                <label>City</label>
                <input class="input" @bind="City" />
            </div>
            <div class="field">
                <label>School / Club</label>
                <input class="input" @bind="SchoolClub" />
            </div>
            <div class="field">
                <label>Grade</label>
                <select class="select" @bind="Grade">
                    @foreach (var grade in FormOptions.GradeOptions)
                    {
                        <option value="@grade.Value">@grade.Label</option>
                    }
                </select>
            </div>
            <div class="field">
                <label>Weight Class</label>
                <select class="select" @bind="WeightClass">
                    @foreach (var weight in ProfileWeightOptions)
                    {
                        <option value="@weight">@weight lbs</option>
                    }
                </select>
            </div>
            <div class="field">
                <label>Level</label>
                <select class="select" @bind="Level">
                    @foreach (var level in Enum.GetValues<CompetitionLevel>())
                    {
                        <option value="@level">@level</option>
                    }
                </select>
            </div>
        </div>
        <div class="actions">
            <button class="btn secondary" @onclick="CreateProfileAsync" disabled="@IsBusy">Save Athlete Profile</button>
        </div>
        @if (!string.IsNullOrWhiteSpace(ProfileMessage))
        {
            <div class="alert @(ProfileSuccess ? "success" : "error")">@ProfileMessage</div>
        }
        @if (CreatedAthleteId is not null)
        {
            <p class="helper spacer-top">Athlete id: <span class="mono">@CreatedAthleteId</span></p>
        }
    </section>

    <section class="panel">
        <h2>3) Event Discovery & Entry</h2>
        <div class="form-grid spacer-top">
            <div class="field">
                <label>Search State</label>
                <select class="select" @bind="SearchState">
                    @foreach (var state in FormOptions.UsStatesWithAny)
                    {
                        <option value="@state.Code">@state.Name</option>
                    }
                </select>
            </div>
            <div class="field">
                <label>Search City</label>
                <input class="input" @bind="SearchCity" placeholder="Columbus" />
            </div>
            <div class="field">
                <label>Level</label>
                <select class="select" @bind="SearchLevel">
                    <option value="">All</option>
                    @foreach (var level in Enum.GetValues<CompetitionLevel>())
                    {
                        <option value="@level">@level</option>
                    }
                </select>
            </div>
            <div class="field">
                <label>Max Entry Fee (cents)</label>
                <input class="input" type="number" min="0" @bind="MaxFeeCents" />
            </div>
        </div>
        <div class="actions">
            <button class="btn primary" @onclick="SearchEventsAsync" disabled="@IsBusy">Search Events</button>
        </div>

        <div class="table-wrap spacer-top">
            <table class="table">
                <thead>
                    <tr>
                        <th>Event</th>
                        <th>Location</th>
                        <th>Date</th>
                        <th>Fee</th>
                        <th>Id</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @if (SearchedEvents.Count == 0)
                    {
                        <tr><td colspan="6">No results yet.</td></tr>
                    }
                    else
                    {
                        @foreach (var tournamentEvent in SearchedEvents)
                        {
                            <tr>
                                <td>@tournamentEvent.Name</td>
                                <td>@tournamentEvent.State / @tournamentEvent.City</td>
                                <td>@tournamentEvent.StartUtc.ToLocalTime().ToString("MMM dd")</td>
                                <td>$@((tournamentEvent.EntryFeeCents / 100m).ToString("0.00"))</td>
                                <td class="mono">@tournamentEvent.Id.ToString()[..8]</td>
                                <td>
                                    <div class="actions">
                                        <button class="btn ghost" @onclick="() => UseEventForRegistration(tournamentEvent.Id)">Use</button>
                                        <a class="btn secondary" href="@BracketsRoute(tournamentEvent.Id)">Brackets</a>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <hr class="soft" />

        <h3>Register For Tournament</h3>
        <div class="form-grid spacer-top">
            <div class="field">
                <label>Event Id</label>
                <input class="input mono" @bind="RegistrationEventId" />
            </div>
            <div class="field">
                <label>Athlete Id</label>
                <input class="input mono" @bind="RegistrationAthleteId" />
            </div>
            <div class="field">
                <label>Team Id (optional)</label>
                <input class="input mono" @bind="RegistrationTeamId" />
            </div>
            <div class="field check-row">
                <input id="freeagent" type="checkbox" @bind="RegisterAsFreeAgent" />
                <label for="freeagent">Register as free agent</label>
            </div>
        </div>
        <div class="actions">
            <button class="btn secondary" @onclick="RegisterForEventAsync" disabled="@IsBusy">Submit Registration</button>
        </div>
        @if (!string.IsNullOrWhiteSpace(RegistrationMessage))
        {
            <div class="alert @(RegistrationSuccess ? "success" : "error")">@RegistrationMessage</div>
        }
        @if (LastPaymentIntent is not null)
        {
            <div class="alert success">Checkout: <a href="@LastPaymentIntent.CheckoutUrl" target="_blank">@LastPaymentIntent.CheckoutUrl</a></div>
        }
    </section>
</div>

<div class="panel-grid two spacer-top">
    <section class="panel">
        <h2>4) Rankings + Stat History</h2>

        <div class="form-grid spacer-top">
            <div class="field">
                <label>Ranking Level</label>
                <select class="select" @bind="RankingLevel">
                    @foreach (var level in Enum.GetValues<CompetitionLevel>())
                    {
                        <option value="@level">@level</option>
                    }
                </select>
            </div>
            <div class="field">
                <label>Ranking State</label>
                <select class="select" @bind="RankingState">
                    @foreach (var state in FormOptions.UsStatesWithAny)
                    {
                        <option value="@state.Code">@state.Name</option>
                    }
                </select>
            </div>
            <div class="field">
                <label>Take</label>
                <input class="input" type="number" min="1" max="200" @bind="RankingTake" />
            </div>
        </div>
        <div class="actions">
            <button class="btn primary" @onclick="LoadRankingsAsync" disabled="@IsBusy">Load Rankings</button>
        </div>

        <div class="table-wrap spacer-top">
            <table class="table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Athlete Id</th>
                        <th>Rating</th>
                        <th>State</th>
                    </tr>
                </thead>
                <tbody>
                    @if (RankingRows.Count == 0)
                    {
                        <tr><td colspan="4">No ranking data.</td></tr>
                    }
                    else
                    {
                        @foreach (var row in RankingRows)
                        {
                            <tr>
                                <td>@row.Rank</td>
                                <td class="mono">@row.AthleteProfileId.ToString()[..8]</td>
                                <td>@row.RatingPoints.ToString("0.0")</td>
                                <td>@row.State</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <hr class="soft" />

        <div class="form-grid">
            <div class="field">
                <label>Athlete Id For Stat History</label>
                <input class="input mono" @bind="StatsAthleteId" />
            </div>
        </div>
        <div class="actions">
            <button class="btn ghost" @onclick="LoadStatsAsync" disabled="@IsBusy">Load Historical Stats</button>
        </div>

        <div class="table-wrap spacer-top">
            <table class="table">
                <thead>
                    <tr>
                        <th>Snapshot</th>
                        <th>W</th>
                        <th>L</th>
                        <th>Pins</th>
                        <th>Tech</th>
                        <th>Majors</th>
                    </tr>
                </thead>
                <tbody>
                    @if (StatsRows.Count == 0)
                    {
                        <tr><td colspan="6">No history loaded.</td></tr>
                    }
                    else
                    {
                        @foreach (var snapshot in StatsRows.Take(20))
                        {
                            <tr>
                                <td>@snapshot.SnapshotUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                                <td>@snapshot.Wins</td>
                                <td>@snapshot.Losses</td>
                                <td>@snapshot.Pins</td>
                                <td>@snapshot.TechFalls</td>
                                <td>@snapshot.MajorDecisions</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </section>

    <section class="panel">
        <h2>5) Notification Subscriptions</h2>
        <p class="helper">Subscribe to mat assignment, in-the-hole, and results by email, SMS, or both.</p>

        <div class="form-grid spacer-top">
            <div class="field">
                <label>User Id</label>
                <input class="input mono" @bind="NotifyUserId" />
            </div>
            <div class="field">
                <label>Event Id (optional)</label>
                <input class="input mono" @bind="NotifyEventId" />
            </div>
            <div class="field">
                <label>Athlete Id (optional)</label>
                <input class="input mono" @bind="NotifyAthleteId" />
            </div>
            <div class="field">
                <label>Event Type</label>
                <select class="select" @bind="NotifyEventType">
                    @foreach (var type in Enum.GetValues<NotificationEventType>())
                    {
                        <option value="@type">@type</option>
                    }
                </select>
            </div>
            <div class="field">
                <label>Channel</label>
                <select class="select" @bind="NotifyChannel">
                    @foreach (var channel in Enum.GetValues<NotificationChannel>())
                    {
                        <option value="@channel">@channel</option>
                    }
                </select>
            </div>
            <div class="field">
                <label>Destination</label>
                <input class="input" @bind="NotifyDestination" placeholder="email or phone" />
            </div>
        </div>

        <div class="actions">
            <button class="btn secondary" @onclick="SubscribeAsync" disabled="@IsBusy">Save Subscription</button>
            <button class="btn ghost" @onclick="LoadNotificationMessagesAsync" disabled="@IsBusy">Load Message Feed</button>
        </div>

        @if (!string.IsNullOrWhiteSpace(NotificationStatusMessage))
        {
            <div class="alert @(NotificationSuccess ? "success" : "error")">@NotificationStatusMessage</div>
        }

        <div class="timeline spacer-top">
            @if (NotificationStatusMessages.Count == 0)
            {
                <div class="timeline-item">No notification feed loaded.</div>
            }
            else
            {
                @foreach (var msg in NotificationStatusMessages.Take(12))
                {
                    <div class="timeline-item">
                        <strong>@msg.EventType</strong> via @msg.Channel<br />
                        <span class="helper">@msg.Body</span>
                    </div>
                }
            }
        </div>
    </section>
</div>

<div class="panel-grid two spacer-top">
    <section class="panel">
        <h2>6) Media Vault + AI Highlights</h2>
        <p class="helper">Save stream footage, queue transcode + AI clip extraction, and build recruiting-ready media history.</p>

        <div class="form-grid spacer-top">
            <div class="field">
                <label>Athlete Id</label>
                <input class="input mono" @bind="MediaAthleteId" />
            </div>
            <div class="field">
                <label>Match Id</label>
                <input class="input mono" @bind="MediaMatchId" />
            </div>
            <div class="field">
                <label>Stream Id (optional)</label>
                <input class="input mono" @bind="MediaStreamId" />
            </div>
            <div class="field">
                <label>Video Source URL</label>
                <input class="input" @bind="MediaSourceUrl" placeholder="https://.../mat1.mp4 or .m3u8" />
            </div>
            <div class="field check-row">
                <input id="queuetranscode" type="checkbox" @bind="QueueTranscode" />
                <label for="queuetranscode">Queue transcode pipeline</label>
            </div>
        </div>

        <div class="actions">
            <button class="btn primary" @onclick="CreateVideoAssetAsync" disabled="@IsBusy">Save Video Asset</button>
            <button class="btn secondary" @onclick="QueueHighlightsAsync" disabled="@IsBusy">Queue AI Highlights</button>
            <button class="btn ghost" @onclick="LoadVideosAsync" disabled="@IsBusy">Load Video Vault</button>
            <button class="btn ghost" @onclick="LoadAiJobsAsync" disabled="@IsBusy">Load AI Jobs</button>
            <button class="btn ghost" @onclick="LoadHighlightsAsync" disabled="@IsBusy">Load AI Highlights</button>
            <button class="btn ghost" @onclick="UseWorkflowAthleteForMedia">Use Workflow Athlete</button>
        </div>

        @if (!string.IsNullOrWhiteSpace(MediaMessage))
        {
            <div class="alert @(MediaSuccess ? "success" : "error")">@MediaMessage</div>
        }

        <h3 class="spacer-top">Video Vault</h3>
        <div class="table-wrap spacer-top">
            <table class="table">
                <thead>
                    <tr>
                        <th>Video</th>
                        <th>Match</th>
                        <th>State</th>
                        <th>Ready</th>
                        <th>Playback</th>
                    </tr>
                </thead>
                <tbody>
                    @if (VideoAssets.Count == 0)
                    {
                        <tr><td colspan="5">No media assets loaded.</td></tr>
                    }
                    else
                    {
                        @foreach (var video in VideoAssets.Take(20))
                        {
                            <tr>
                                <td class="mono">@video.VideoId.ToString()[..8]</td>
                                <td class="mono">@video.MatchId.ToString()[..8]</td>
                                <td>@video.State</td>
                                <td>@(video.ReadyUtc?.ToLocalTime().ToString("HH:mm:ss") ?? "-")</td>
                                <td><a href="@video.PlaybackUrl" target="_blank">Open</a></td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <h3 class="spacer-top">AI Queue</h3>
        <div class="table-wrap spacer-top">
            <table class="table">
                <thead>
                    <tr>
                        <th>Job</th>
                        <th>Status</th>
                        <th>Clips</th>
                        <th>Queued</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    @if (AiJobs.Count == 0)
                    {
                        <tr><td colspan="5">No AI jobs loaded.</td></tr>
                    }
                    else
                    {
                        @foreach (var job in AiJobs.Take(12))
                        {
                            <tr>
                                <td class="mono">@job.JobId.ToString()[..8]</td>
                                <td>@job.Status</td>
                                <td>@job.ClipsProduced</td>
                                <td>@job.QueuedUtc.ToLocalTime().ToString("HH:mm:ss")</td>
                                <td>@job.Details</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <h3 class="spacer-top">Highlight Clips</h3>
        <div class="table-wrap spacer-top">
            <table class="table">
                <thead>
                    <tr>
                        <th>Clip</th>
                        <th>Impact</th>
                        <th>Match</th>
                        <th>Playback</th>
                    </tr>
                </thead>
                <tbody>
                    @if (HighlightClips.Count == 0)
                    {
                        <tr><td colspan="4">No highlight clips loaded.</td></tr>
                    }
                    else
                    {
                        @foreach (var clip in HighlightClips)
                        {
                            <tr>
                                <td>@clip.Title<br /><span class="helper">@clip.Summary</span></td>
                                <td>@clip.ImpactScore</td>
                                <td class="mono">@clip.MatchId.ToString()[..8]</td>
                                <td><a href="@clip.PlaybackUrl" target="_blank">Open</a></td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </section>

    <section class="panel">
        <h2>7) NIL Profile Snapshot</h2>
        <p class="helper">Athlete brand profile built from verified performance and engagement signals plus configurable NIL social presence.</p>

        <div class="actions spacer-top">
            <button class="btn primary" @onclick="LoadNilProfileAsync" disabled="@IsBusy">Load NIL Profile</button>
            <button class="btn secondary" @onclick="SaveNilProfileAsync" disabled="@IsBusy">Save NIL Socials</button>
            <button class="btn ghost" @onclick="LoadNilPolicyAsync" disabled="@IsBusy">Load NIL Policy</button>
        </div>

        @if (NilProfile is null)
        {
            <div class="helper spacer-top">No NIL profile loaded yet.</div>
        }
        else
        {
            <div class="metric-grid spacer-top">
                <div class="metric-card">
                    <div class="metric-label">Followers</div>
                    <div class="metric-value">@NilProfile.Followers</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Rating</div>
                    <div class="metric-value">@NilProfile.RatingPoints.ToString("0.0")</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Marketability</div>
                    <div class="metric-value">@NilProfile.MarketabilityScore.ToString("0.0")</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Career W-L</div>
                    <div class="metric-value">@NilProfile.CareerWins-@NilProfile.CareerLosses</div>
                </div>
            </div>

            <div class="timeline spacer-top">
                @foreach (var tag in NilProfile.RecruitingTags)
                {
                    <div class="timeline-item">@tag</div>
                }
            </div>

            <div class="form-grid spacer-top">
                <div class="field">
                    <label>X handle</label>
                    <input class="input" @bind="NilXHandle" placeholder="athletex" />
                </div>
                <div class="field">
                    <label>Instagram handle</label>
                    <input class="input" @bind="NilInstagramHandle" placeholder="athletegram" />
                </div>
                <div class="field">
                    <label>Twitter handle</label>
                    <input class="input" @bind="NilTwitterHandle" placeholder="athletetwitter" />
                </div>
                <div class="field">
                    <label>NIL contact email</label>
                    <input class="input" @bind="NilContactEmail" placeholder="athlete@school.edu" />
                </div>
                <div class="field check-row">
                    <input id="nilBrands" type="checkbox" @bind="NilOpenToBrandDeals" />
                    <label for="nilBrands">Open to brand deals</label>
                </div>
                <div class="field check-row">
                    <input id="nilCamps" type="checkbox" @bind="NilOpenToCampsClinics" />
                    <label for="nilCamps">Open to camps/clinics</label>
                </div>
                <div class="field check-row">
                    <input id="nilCollectives" type="checkbox" @bind="NilOpenToCollectives" />
                    <label for="nilCollectives">Open to collectives</label>
                </div>
                <div class="field">
                    <label>NIL bio</label>
                    <textarea class="textarea" @bind="NilBio"></textarea>
                </div>
            </div>
        }

        @if (NilPolicy is not null)
        {
            <hr class="soft" />
            <h3>NIL Compliance Quick Guidance</h3>
            <p class="helper spacer-top">@NilPolicy.LegalNotice</p>
            <div class="table-wrap spacer-top">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Audience</th>
                            <th>Jurisdiction</th>
                            <th>Summary</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var rule in NilPolicy.Rules)
                        {
                            <tr>
                                <td>@rule.Audience</td>
                                <td>@rule.Jurisdiction</td>
                                <td>@rule.Summary</td>
                                <td><a href="@rule.SourceUrl" target="_blank">@rule.SourceName</a></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </section>
</div>

@code {
    protected override void OnInitialized()
    {
        ApplyWorkflowContext();
    }

    private void UseDemoAthleteCredentials()
    {
        AccountEmail = "demo.athlete@pinpointarena.local";
        AccountPassword = "DemoPass!123";
        AccountPhone = "+16145550002";
    }

    private void ApplyWorkflowContext()
    {
        if (Workflow.AthleteUserId is not null)
        {
            ProfileUserId = Workflow.AthleteUserId.Value.ToString();
            NotifyUserId = Workflow.AthleteUserId.Value.ToString();
        }

        if (Workflow.AthleteProfileId is not null)
        {
            RegistrationAthleteId = Workflow.AthleteProfileId.Value.ToString();
            StatsAthleteId = Workflow.AthleteProfileId.Value.ToString();
            NotifyAthleteId = Workflow.AthleteProfileId.Value.ToString();
            MediaAthleteId = Workflow.AthleteProfileId.Value.ToString();
        }

        if (Workflow.EventId is not null)
        {
            RegistrationEventId = Workflow.EventId.Value.ToString();
            NotifyEventId = Workflow.EventId.Value.ToString();
        }

        if (Workflow.MatchId is not null)
        {
            MediaMatchId = Workflow.MatchId.Value.ToString();
        }
    }

    private async Task LoadLatestEventAsync()
    {
        IsBusy = true;
        RegistrationMessage = null;

        var result = await ApiClient.SearchEventsAsync(new SearchEventsQuery(
            "OH",
            null,
            null,
            DateTime.UtcNow.Date.AddDays(-1),
            null,
            null));

        if (result.Success && result.Data is not null && result.Data.Count > 0)
        {
            var latest = result.Data.OrderBy(x => x.StartUtc).First();
            RegistrationEventId = latest.Id.ToString();
            NotifyEventId = latest.Id.ToString();
            Workflow.EventId = latest.Id;
            RegistrationSuccess = true;
            RegistrationMessage = $"Selected event {latest.Name} ({latest.State}/{latest.City}).";
        }
        else
        {
            RegistrationSuccess = false;
            RegistrationMessage = result.Success ? "No events found." : result.Message;
        }

        IsBusy = false;
    }

    private static string Short(Guid? id) => id is null ? "-" : id.Value.ToString()[..8];
    private bool IsBusy;

    private string AccountEmail = "athlete@example.com";
    private string AccountPassword = "S3curePass!";
    private string? AccountPhone = "+16145550101";
    private string? AccountMessage;
    private bool AccountSuccess;
    private Guid? CreatedUserId;

    private string ProfileUserId = string.Empty;
    private string FirstName = "Eli";
    private string LastName = "Turner";
    private string BirthDateText = "2010-04-15";
    private string State = "OH";
    private string City = "Columbus";
    private string SchoolClub = "Central Wrestling Club";
    private int Grade = 10;
    private decimal WeightClass = 132m;
    private CompetitionLevel Level = CompetitionLevel.HighSchool;
    private IReadOnlyList<decimal> ProfileWeightOptions => FormOptions.WeightClassesFor(Level);
    private string? ProfileMessage;
    private bool ProfileSuccess;
    private Guid? CreatedAthleteId;

    private string SearchState = "OH";
    private string SearchCity = string.Empty;
    private CompetitionLevel? SearchLevel = CompetitionLevel.HighSchool;
    private int? MaxFeeCents;
    private List<TournamentEvent> SearchedEvents = [];

    private string RegistrationEventId = string.Empty;
    private string RegistrationAthleteId = string.Empty;
    private string RegistrationTeamId = string.Empty;
    private bool RegisterAsFreeAgent;
    private string? RegistrationMessage;
    private bool RegistrationSuccess;
    private PaymentIntentResult? LastPaymentIntent;

    private CompetitionLevel RankingLevel = CompetitionLevel.HighSchool;
    private string RankingState = "OH";
    private int RankingTake = 25;
    private List<AthleteRanking> RankingRows = [];

    private string StatsAthleteId = string.Empty;
    private List<AthleteStatsSnapshot> StatsRows = [];

    private string NotifyUserId = string.Empty;
    private string NotifyEventId = string.Empty;
    private string NotifyAthleteId = string.Empty;
    private NotificationEventType NotifyEventType = NotificationEventType.MatchResult;
    private NotificationChannel NotifyChannel = NotificationChannel.Email;
    private string NotifyDestination = "family@example.com";
    private string? NotificationStatusMessage;
    private bool NotificationSuccess;
    private List<NotificationMessage> NotificationStatusMessages = [];

    private string MediaAthleteId = string.Empty;
    private string MediaMatchId = string.Empty;
    private string MediaStreamId = string.Empty;
    private string MediaSourceUrl = "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8";
    private bool QueueTranscode = true;
    private List<VideoAssetRecord> VideoAssets = [];
    private List<AiHighlightJobSnapshot> AiJobs = [];
    private List<AthleteHighlightClip> HighlightClips = [];
    private string? MediaMessage;
    private bool MediaSuccess;
    private AthleteNilProfile? NilProfile;
    private NilPolicyResponse? NilPolicy;
    private string NilXHandle = string.Empty;
    private string NilInstagramHandle = string.Empty;
    private string NilTwitterHandle = string.Empty;
    private string NilContactEmail = string.Empty;
    private bool NilOpenToBrandDeals = true;
    private bool NilOpenToCampsClinics = true;
    private bool NilOpenToCollectives = true;
    private string NilBio = string.Empty;

    private async Task RegisterUserAsync()
    {
        IsBusy = true;
        AccountMessage = null;

        var result = await ApiClient.RegisterUserAsync(new RegisterUserRequest(AccountEmail, AccountPassword, UserRole.Athlete, AccountPhone));
        AccountSuccess = result.Success;
        AccountMessage = result.Success ? $"Athlete user created: {result.Data?.Email}" : result.Message;

        if (result.Success && result.Data is not null)
        {
            CreatedUserId = result.Data.Id;
            ProfileUserId = result.Data.Id.ToString();
            NotifyUserId = result.Data.Id.ToString();
            Workflow.AthleteUserId = result.Data.Id;

            var loginResult = await ApiClient.LoginAsync(new LoginRequest(AccountEmail, AccountPassword));
            if (!loginResult.Success)
            {
                AccountSuccess = false;
                AccountMessage = $"User created, but sign-in failed: {loginResult.Message}";
            }
        }

        IsBusy = false;
    }

    private async Task CreateProfileAsync()
    {
        IsBusy = true;
        ProfileMessage = null;

        if (!Guid.TryParse(ProfileUserId, out var userId))
        {
            ProfileSuccess = false;
            ProfileMessage = "Valid user id is required.";
            IsBusy = false;
            return;
        }

        if (!DateTime.TryParse(BirthDateText, out var birthDate))
        {
            ProfileSuccess = false;
            ProfileMessage = "Valid birth date is required.";
            IsBusy = false;
            return;
        }

        if (!ProfileWeightOptions.Contains(WeightClass))
        {
            WeightClass = ProfileWeightOptions[0];
        }

        var request = new CreateAthleteProfileRequest(
            userId,
            FirstName,
            LastName,
            DateTime.SpecifyKind(birthDate, DateTimeKind.Utc),
            State,
            City,
            SchoolClub,
            Grade,
            WeightClass,
            Level);

        var result = await ApiClient.CreateAthleteProfileAsync(request);
        ProfileSuccess = result.Success;
        ProfileMessage = result.Success ? "Athlete profile saved." : result.Message;

        if (result.Success && result.Data is not null)
        {
            CreatedAthleteId = result.Data.Id;
            RegistrationAthleteId = result.Data.Id.ToString();
            StatsAthleteId = result.Data.Id.ToString();
            NotifyAthleteId = result.Data.Id.ToString();
            Workflow.AthleteUserId = userId;
            Workflow.AthleteProfileId = result.Data.Id;
        }

        IsBusy = false;
    }

    private async Task SearchEventsAsync()
    {
        IsBusy = true;
        RegistrationMessage = null;

        var request = new SearchEventsQuery(
            string.IsNullOrWhiteSpace(SearchState) ? null : SearchState,
            string.IsNullOrWhiteSpace(SearchCity) ? null : SearchCity,
            SearchLevel,
            DateTime.UtcNow.Date,
            null,
            MaxFeeCents);

        var result = await ApiClient.SearchEventsAsync(request);

        if (result.Success)
        {
            SearchedEvents = result.Data ?? [];
            RegistrationMessage = $"Loaded {SearchedEvents.Count} events.";
            RegistrationSuccess = true;

            if (SearchedEvents.Count > 0)
            {
                RegistrationEventId = SearchedEvents[0].Id.ToString();
                NotifyEventId = SearchedEvents[0].Id.ToString();
                Workflow.EventId = SearchedEvents[0].Id;
            }
        }
        else
        {
            RegistrationSuccess = false;
            RegistrationMessage = result.Message;
        }

        IsBusy = false;
    }

    private void UseEventForRegistration(Guid eventId)
    {
        RegistrationEventId = eventId.ToString();
        NotifyEventId = eventId.ToString();
        Workflow.EventId = eventId;
        RegistrationSuccess = true;
        RegistrationMessage = $"Selected event {eventId.ToString()[..8]} for registration.";
    }

    private async Task RegisterForEventAsync()
    {
        IsBusy = true;
        RegistrationMessage = null;
        LastPaymentIntent = null;

        if (!Guid.TryParse(RegistrationEventId, out var eventId) || !Guid.TryParse(RegistrationAthleteId, out var athleteId))
        {
            RegistrationSuccess = false;
            RegistrationMessage = "Valid event id and athlete id are required.";
            IsBusy = false;
            return;
        }

        Guid? teamId = Guid.TryParse(RegistrationTeamId, out var parsedTeamId) ? parsedTeamId : null;

        var result = await ApiClient.RegisterAthleteForEventAsync(eventId, new RegisterForEventRequest(athleteId, teamId, RegisterAsFreeAgent));

        RegistrationSuccess = result.Success;
        RegistrationMessage = result.Success
            ? $"Registration submitted. Status: {result.Data?.Registration?.Status}"
            : result.Message;

        LastPaymentIntent = result.Data?.PaymentIntent;
        Workflow.EventId = eventId;
        if (teamId is not null)
        {
            Workflow.TeamId = teamId;
        }

        IsBusy = false;
    }

    private async Task LoadRankingsAsync()
    {
        IsBusy = true;
        var result = await ApiClient.GetRankingsAsync(RankingLevel, RankingState, RankingTake);

        if (result.Success)
        {
            RankingRows = result.Data ?? [];
        }
        else
        {
            NotificationStatusMessage = result.Message;
            NotificationSuccess = false;
        }

        IsBusy = false;
    }

    private async Task LoadStatsAsync()
    {
        IsBusy = true;

        if (!Guid.TryParse(StatsAthleteId, out var athleteId))
        {
            NotificationStatusMessage = "Valid athlete id is required for history lookup.";
            NotificationSuccess = false;
            IsBusy = false;
            return;
        }

        var result = await ApiClient.GetAthleteStatsHistoryAsync(athleteId);
        if (result.Success)
        {
            StatsRows = result.Data ?? [];
        }
        else
        {
            NotificationStatusMessage = result.Message;
            NotificationSuccess = false;
        }

        IsBusy = false;
    }

    private async Task SubscribeAsync()
    {
        IsBusy = true;

        if (!Guid.TryParse(NotifyUserId, out var userId))
        {
            NotificationSuccess = false;
            NotificationStatusMessage = "Valid user id is required.";
            IsBusy = false;
            return;
        }

        Guid? eventId = Guid.TryParse(NotifyEventId, out var parsedEventId) ? parsedEventId : null;
        Guid? athleteId = Guid.TryParse(NotifyAthleteId, out var parsedAthleteId) ? parsedAthleteId : null;

        var result = await ApiClient.SubscribeAsync(new SubscribeNotificationRequest(
            userId,
            eventId,
            athleteId,
            NotifyEventType,
            NotifyChannel,
            NotifyDestination));

        NotificationSuccess = result.Success;
        NotificationStatusMessage = result.Success ? "Subscription saved." : result.Message;

        IsBusy = false;
    }

    private async Task LoadNotificationMessagesAsync()
    {
        IsBusy = true;

        if (!Guid.TryParse(NotifyUserId, out var userId))
        {
            NotificationSuccess = false;
            NotificationStatusMessage = "Valid user id is required for feed lookup.";
            IsBusy = false;
            return;
        }

        var result = await ApiClient.GetNotificationMessagesAsync(userId);
        if (result.Success)
        {
            NotificationStatusMessages = result.Data ?? [];
            NotificationSuccess = true;
            NotificationStatusMessage = $"Loaded {NotificationStatusMessages.Count} notification messages.";
        }
        else
        {
            NotificationSuccess = false;
            NotificationStatusMessage = result.Message;
        }

        IsBusy = false;
    }

    private void UseWorkflowAthleteForMedia()
    {
        if (Workflow.AthleteProfileId is null)
        {
            MediaSuccess = false;
            MediaMessage = "Workflow athlete id is empty.";
            return;
        }

        MediaAthleteId = Workflow.AthleteProfileId.Value.ToString();
        if (Workflow.MatchId is not null)
        {
            MediaMatchId = Workflow.MatchId.Value.ToString();
        }
        MediaSuccess = true;
        MediaMessage = "Workflow athlete applied for media + NIL.";
    }

    private async Task CreateVideoAssetAsync()
    {
        IsBusy = true;
        MediaMessage = null;

        if (!Guid.TryParse(MediaAthleteId, out var athleteId) || !Guid.TryParse(MediaMatchId, out var matchId))
        {
            MediaSuccess = false;
            MediaMessage = "Valid athlete id and match id are required.";
            IsBusy = false;
            return;
        }

        Guid? streamId = Guid.TryParse(MediaStreamId, out var parsedStreamId) ? parsedStreamId : null;
        var result = await ApiClient.CreateVideoAssetAsync(new CreateVideoAssetRequest(
            athleteId,
            matchId,
            streamId,
            MediaSourceUrl,
            QueueTranscode));

        MediaSuccess = result.Success;
        MediaMessage = result.Success
            ? $"Video asset saved: {result.Data?.VideoId.ToString()[..8]} ({result.Data?.State})"
            : result.Message;

        if (result.Success)
        {
            await LoadVideosAsync();
            Workflow.MatchId = matchId;
        }

        IsBusy = false;
    }

    private async Task QueueHighlightsAsync()
    {
        IsBusy = true;
        MediaMessage = null;

        if (!Guid.TryParse(MediaAthleteId, out var athleteId))
        {
            MediaSuccess = false;
            MediaMessage = "Valid athlete id is required.";
            IsBusy = false;
            return;
        }

        Guid? eventId = Guid.TryParse(RegistrationEventId, out var parsedEventId) ? parsedEventId : null;
        var result = await ApiClient.QueueAiHighlightsAsync(new QueueAiHighlightsRequest(athleteId, eventId, MaxMatches: 12));
        MediaSuccess = result.Success;
        MediaMessage = result.Success ? "AI highlight job queued." : result.Message;

        if (result.Success)
        {
            await LoadAiJobsAsync();
        }

        IsBusy = false;
    }

    private async Task LoadVideosAsync()
    {
        if (!Guid.TryParse(MediaAthleteId, out var athleteId))
        {
            return;
        }

        var result = await ApiClient.GetAthleteVideosAsync(athleteId);
        if (result.Success)
        {
            VideoAssets = result.Data ?? [];
        }
    }

    private async Task LoadAiJobsAsync()
    {
        if (!Guid.TryParse(MediaAthleteId, out var athleteId))
        {
            return;
        }

        var result = await ApiClient.GetAiHighlightJobsAsync(athleteId);
        if (result.Success)
        {
            AiJobs = result.Data ?? [];
        }
    }

    private async Task LoadHighlightsAsync()
    {
        IsBusy = true;
        MediaMessage = null;

        if (!Guid.TryParse(MediaAthleteId, out var athleteId))
        {
            MediaSuccess = false;
            MediaMessage = "Valid athlete id is required.";
            IsBusy = false;
            return;
        }

        var result = await ApiClient.GetAthleteHighlightsAsync(athleteId);
        MediaSuccess = result.Success;
        MediaMessage = result.Success ? $"Loaded {result.Data?.Count ?? 0} highlight clips." : result.Message;
        HighlightClips = result.Data ?? [];
        if (result.Success)
        {
            await LoadVideosAsync();
            await LoadAiJobsAsync();
        }

        IsBusy = false;
    }

    private async Task LoadNilProfileAsync()
    {
        IsBusy = true;

        if (!Guid.TryParse(MediaAthleteId, out var athleteId))
        {
            MediaSuccess = false;
            MediaMessage = "Valid athlete id is required.";
            IsBusy = false;
            return;
        }

        var result = await ApiClient.GetAthleteNilProfileAsync(athleteId);
        MediaSuccess = result.Success;
        MediaMessage = result.Success ? "NIL profile loaded." : result.Message;
        NilProfile = result.Data;

        if (NilProfile is not null)
        {
            NilXHandle = NilProfile.XHandle ?? string.Empty;
            NilInstagramHandle = NilProfile.InstagramHandle ?? string.Empty;
            NilTwitterHandle = NilProfile.TwitterHandle ?? string.Empty;
            NilContactEmail = NilProfile.ContactEmail ?? string.Empty;
            NilOpenToBrandDeals = NilProfile.OpenToBrandDeals;
            NilOpenToCampsClinics = NilProfile.OpenToCampsClinics;
            NilOpenToCollectives = NilProfile.OpenToCollectives;
            NilBio = NilProfile.Bio ?? string.Empty;
        }

        IsBusy = false;
    }

    private async Task SaveNilProfileAsync()
    {
        IsBusy = true;

        if (!Guid.TryParse(MediaAthleteId, out var athleteId))
        {
            MediaSuccess = false;
            MediaMessage = "Valid athlete id is required.";
            IsBusy = false;
            return;
        }

        var result = await ApiClient.UpdateAthleteNilProfileAsync(
            athleteId,
            new UpdateAthleteNilProfileRequest(
                NilXHandle,
                NilInstagramHandle,
                NilTwitterHandle,
                NilContactEmail,
                NilOpenToBrandDeals,
                NilOpenToCampsClinics,
                NilOpenToCollectives,
                NilBio));

        MediaSuccess = result.Success;
        MediaMessage = result.Success ? "NIL social profile saved." : result.Message;
        NilProfile = result.Data;
        IsBusy = false;
    }

    private async Task LoadNilPolicyAsync()
    {
        IsBusy = true;
        var result = await ApiClient.GetNilPolicyAsync();
        MediaSuccess = result.Success;
        MediaMessage = result.Success ? "NIL policy loaded." : result.Message;
        NilPolicy = result.Data;
        IsBusy = false;
    }

    private static string BracketsRoute(Guid eventId) => $"/brackets?eventId={eventId:D}";
}











