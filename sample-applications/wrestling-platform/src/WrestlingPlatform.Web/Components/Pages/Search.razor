@page "/search"
@inject PlatformApiClient ApiClient

<PageTitle>Search - PinPoint Arena</PageTitle>

<div class="page-head">
    <div>
        <h1 class="page-title">Global Search</h1>
        <p class="page-subtitle">Search athletes, coaches, teams, tournaments, matches, and live streams from one place.</p>
    </div>
    <div class="tag-row">
        <span class="tag">Search Anything</span>
        <span class="tag">Workflow-Aware</span>
        <span class="tag">Fast Results</span>
    </div>
</div>

<section class="panel">
    <MudStack Row="true" Spacing="2" Class="spacer-top">
        <MudTextField T="string"
                      Label="Search Query"
                      Variant="Variant.Outlined"
                      @bind-Value="Query"
                      Immediate="true"
                      Placeholder="Try athlete name, city, team, event, mat, stream..."
                      OnKeyDown="OnQueryKeyDown" />
        <MudNumericField T="int"
                         Label="Max Results"
                         Variant="Variant.Outlined"
                         Min="5"
                         Max="60"
                         @bind-Value="Take" />
    </MudStack>
    <div class="actions">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SearchAsync" Disabled="@IsBusy">Search</MudButton>
    </div>

    @if (!string.IsNullOrWhiteSpace(StatusMessage))
    {
        <div class="alert @(StatusSuccess ? "success" : "error") spacer-top">@StatusMessage</div>
    }
</section>

<section class="panel spacer-top">
    <div class="item-head">
        <h2>Results</h2>
        <span class="tag">@(Results?.Count ?? 0) returned</span>
    </div>

    @if (Results is null || Results.Count == 0)
    {
        <p class="helper spacer-top">No results yet.</p>
    }
    else
    {
        <div class="table-wrap spacer-top">
            <table class="table">
                <thead>
                        <tr>
                            <th>Type</th>
                            <th>Title</th>
                            <th>Details</th>
                            <th>When</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Results)
                    {
                        <tr>
                            <td><MudChip T="string" Size="Size.Small" Color="Color.Secondary">@item.Type</MudChip></td>
                            <td>@item.Title</td>
                            <td>@item.Subtitle</td>
                            <td>@(item.DateUtc?.ToLocalTime().ToString("MMM dd yyyy HH:mm") ?? "-")</td>
                            <td><a class="btn secondary" href="@SearchResultRoute(item)">Open</a></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</section>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "q")]
    public string? QueryParameter { get; set; }

    private bool IsBusy;
    private bool StatusSuccess;
    private string? StatusMessage;
    private string Query = string.Empty;
    private int Take = 24;
    private List<GlobalSearchResultItem>? Results;

    protected override async Task OnParametersSetAsync()
    {
        if (QueryParameter is not null && !string.Equals(Query, QueryParameter, StringComparison.Ordinal))
        {
            Query = QueryParameter;
        }

        if (!string.IsNullOrWhiteSpace(Query))
        {
            await SearchAsync();
        }
    }

    private async Task OnQueryKeyDown(KeyboardEventArgs args)
    {
        if (string.Equals(args.Key, "Enter", StringComparison.OrdinalIgnoreCase))
        {
            await SearchAsync();
        }
    }

    private async Task SearchAsync()
    {
        var trimmed = Query.Trim();
        if (trimmed.Length < 2)
        {
            Results = [];
            StatusSuccess = false;
            StatusMessage = "Enter at least 2 characters.";
            return;
        }

        IsBusy = true;
        try
        {
            var result = await ApiClient.SearchGlobalAsync(trimmed, Take);
            if (!result.Success || result.Data is null)
            {
                StatusSuccess = false;
                StatusMessage = result.Message;
                Results = [];
                return;
            }

            Results = result.Data.Results ?? [];
            StatusSuccess = true;
            StatusMessage = $"Loaded {Results.Count} results for \"{trimmed}\".";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private static string SearchResultRoute(GlobalSearchResultItem item) => item.Type switch
    {
        GlobalSearchEntityType.Athlete => "/athlete",
        GlobalSearchEntityType.Tournament => $"/brackets?eventId={item.Id:D}",
        GlobalSearchEntityType.Match => $"/mat-scoring?matchId={item.Id:D}",
        GlobalSearchEntityType.Team => "/coach",
        GlobalSearchEntityType.Coach => "/coach",
        GlobalSearchEntityType.Stream => "/live",
        _ => item.Route
    };
}
