@page "/ops-checklist"
@inject PlatformApiClient ApiClient
@inject WorkflowState Workflow

<PageTitle>Ops Checklist - PinPoint Arena</PageTitle>

<div class="page-head">
    <div>
        <h1 class="page-title">Tournament Ops Checklist</h1>
        <p class="page-subtitle">Before-event, weigh-in, during-event, and post-event controls with fast outage recovery links for table workers.</p>
    </div>
    <div class="tag-row">
        <span class="tag">Preflight</span>
        <span class="tag">Live Recovery</span>
        <span class="tag">Bracket Gate</span>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(StatusMessage))
{
    <div class="alert @(StatusSuccess ? "success" : "error")">@StatusMessage</div>
}

<section class="panel">
    <h2>Event Context</h2>
    <div class="form-grid spacer-top">
        <div class="field">
            <label>State filter</label>
            <select class="select" @bind="StateFilter">
                @foreach (var state in FormOptions.UsStatesWithAny)
                {
                    <option value="@state.Code">@state.Name</option>
                }
            </select>
        </div>
        <div class="field">
            <label>Selected Event</label>
            <select class="select" @bind="SelectedEventIdText">
                <option value="">Select event...</option>
                @foreach (var evt in Events)
                {
                    <option value="@evt.EventId">@evt.EventName (@evt.State / @evt.City)</option>
                }
            </select>
        </div>
        <div class="field">
            <label>Event Id (manual)</label>
            <input class="input mono" @bind="SelectedEventIdText" />
        </div>
    </div>
    <div class="actions">
        <button class="btn ghost" @onclick="LoadEventsAsync" disabled="@IsBusy">Refresh Events</button>
        <button class="btn ghost" @onclick="UseWorkflowEvent">Use Workflow Event</button>
        <button class="btn primary" @onclick="LoadChecklistAsync" disabled="@IsBusy">Load Checklist</button>
        <a class="btn secondary" href="@SelectedBracketsHref">Open Bracket Center</a>
        <a class="btn ghost" href="@SelectedTableWorkerHref">Open Table Worker</a>
    </div>
</section>

@if (Checklist is not null)
{
    <section class="panel spacer-top">
        <div class="item-head">
            <h2>Checklist Controls</h2>
            <span class="tag">Updated @Checklist.UpdatedUtc.ToLocalTime():g</span>
        </div>
        <div class="form-grid spacer-top">
            <div class="field check-row">
                <input id="ops-divisions-locked" type="checkbox" @bind="DivisionsLocked" />
                <label for="ops-divisions-locked">Lock divisions (age/weight)</label>
            </div>
            <div class="field check-row">
                <input id="ops-rules-locked" type="checkbox" @bind="FormatAndRulesLocked" />
                <label for="ops-rules-locked">Lock format + scoring rules (NFHS/USAW/NCAA)</label>
            </div>
            <div class="field check-row">
                <input id="ops-registration-deadline-set" type="checkbox" @bind="RegistrationDeadlineSet" />
                <label for="ops-registration-deadline-set">Registration deadline configured</label>
            </div>
            <div class="field">
                <label>Registration Deadline (local)</label>
                <input class="input" type="text" @bind="RegistrationDeadlineLocal" placeholder="YYYY-MM-DDTHH:mm" />
            </div>
            <div class="field">
                <label>Seeding Strategy</label>
                <select class="select" @bind="SeedingStrategy">
                    @foreach (var strategy in Enum.GetValues<EventOpsSeedingStrategy>())
                    {
                        <option value="@strategy">@strategy</option>
                    }
                </select>
            </div>
            <div class="field check-row">
                <input id="ops-contingency-print" type="checkbox" @bind="ContingencyPrintReady" />
                <label for="ops-contingency-print">Contingency print kits ready (boards/sheets)</label>
            </div>
            <div class="field check-row">
                <input id="ops-weighins-complete" type="checkbox" @bind="WeighInsCompleted" />
                <label for="ops-weighins-complete">Weigh-ins completed</label>
            </div>
            <div class="field check-row">
                <input id="ops-scratch-frozen" type="checkbox" @bind="ScratchListFrozen" />
                <label for="ops-scratch-frozen">Scratch list frozen</label>
            </div>
            <div class="field check-row">
                <input id="ops-head-table-ready" type="checkbox" @bind="HeadTableReady" />
                <label for="ops-head-table-ready">Head table ready (assignments / printer)</label>
            </div>
            <div class="field check-row">
                <input id="ops-mat-tables-ready" type="checkbox" @bind="MatTablesReady" />
                <label for="ops-mat-tables-ready">Mat tables staffed (scorer + timer)</label>
            </div>
            <div class="field check-row">
                <input id="ops-qr-posted" type="checkbox" @bind="QrPostedForLiveResults" />
                <label for="ops-qr-posted">QR codes posted for live results/schedules</label>
            </div>
            <div class="field check-row">
                <input id="ops-require-scratch-freeze" type="checkbox" @bind="RequireScratchFreezeForBracketGeneration" />
                <label for="ops-require-scratch-freeze">Require scratch freeze before bracket generation</label>
            </div>
            <div class="field check-row">
                <input id="ops-final-results-locked" type="checkbox" @bind="FinalResultsLocked" />
                <label for="ops-final-results-locked">Final results locked</label>
            </div>
            <div class="field check-row">
                <input id="ops-placings-exported" type="checkbox" @bind="PlacingsExported" />
                <label for="ops-placings-exported">Placings exported</label>
            </div>
            <div class="field check-row">
                <input id="ops-team-points-exported" type="checkbox" @bind="TeamPointsExported" />
                <label for="ops-team-points-exported">Team points exported</label>
            </div>
            <div class="field check-row">
                <input id="ops-awards-printed" type="checkbox" @bind="AwardSheetsPrinted" />
                <label for="ops-awards-printed">Award sheets printed</label>
            </div>
            <div class="field check-row">
                <input id="ops-final-brackets-published" type="checkbox" @bind="FinalBracketsPublished" />
                <label for="ops-final-brackets-published">Final brackets published</label>
            </div>
            <div class="field">
                <label>Ops Notes</label>
                <textarea class="input" rows="3" @bind="Notes"></textarea>
            </div>
        </div>
        <div class="actions">
            <button class="btn primary" @onclick="SaveChecklistAsync" disabled="@IsBusy">Save Checklist</button>
            <button class="btn ghost" @onclick="LoadRecoveryAsync" disabled="@IsBusy">Refresh Recovery</button>
            <button class="btn ghost" @onclick="LoadArtifactLinksAsync" disabled="@IsBusy">Refresh Artifact Links</button>
        </div>
        <p class="helper spacer-top">
            Brackets generated after freeze: @(Checklist.BracketsGeneratedAfterScratchFreeze ? "Yes" : "No")
        </p>
    </section>

    @if (ArtifactLinks is not null)
    {
        <section class="panel spacer-top">
            <h2>Live Artifact Links</h2>
            <ul class="list spacer-top">
                <li class="list-item"><a href="@ArtifactLinks.LiveResultsUrl" target="_blank" rel="noopener">Live Results</a></li>
                <li class="list-item"><a href="@ArtifactLinks.MatScheduleUrl" target="_blank" rel="noopener">Mat Schedules</a></li>
                <li class="list-item"><a href="@ArtifactLinks.AwardsSheetUrl" target="_blank" rel="noopener">Award Sheets</a></li>
                <li class="list-item"><a href="@ArtifactLinks.PlacingsExportUrl" target="_blank" rel="noopener">Placings Export</a></li>
                <li class="list-item"><a href="@ArtifactLinks.TeamPointsExportUrl" target="_blank" rel="noopener">Team Points Export</a></li>
            </ul>
        </section>
    }

    <section class="panel spacer-top">
        <div class="item-head">
            <h2>Recovery Snapshot</h2>
            <span class="tag">@RecoveryRows.Count rows</span>
        </div>
        <div class="table-wrap spacer-top">
            <table class="table">
                <thead>
                    <tr>
                        <th>Match</th>
                        <th>Status</th>
                        <th>Mat</th>
                        <th>Period</th>
                        <th>Clock</th>
                        <th>Score</th>
                        <th>Resume</th>
                    </tr>
                </thead>
                <tbody>
                    @if (RecoveryRows.Count == 0)
                    {
                        <tr><td colspan="7">No recovery rows found for this event.</td></tr>
                    }
                    else
                    {
                        @foreach (var row in RecoveryRows)
                        {
                            <tr>
                                <td class="mono">@Short(row.MatchId)</td>
                                <td>@row.Status</td>
                                <td>@(row.MatNumber ?? "TBD")</td>
                                <td>@row.CurrentPeriod</td>
                                <td>@FormatClock(row.ClockSecondsRemaining) @(row.ClockRunning ? "(running)" : string.Empty)</td>
                                <td>@(row.Score ?? "-")</td>
                                <td><a class="btn ghost" href="/mat-scoring?matchId=@row.MatchId">Resume</a></td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </section>
}

@code {
    [SupplyParameterFromQuery(Name = "eventId")]
    public Guid? EventId { get; set; }

    private bool IsBusy;
    private bool StatusSuccess;
    private string? StatusMessage;
    private string StateFilter = "OH";
    private string SelectedEventIdText = string.Empty;
    private List<TableWorkerEventSummary> Events = [];
    private EventOpsChecklistState? Checklist;
    private EventOpsArtifactLinks? ArtifactLinks;
    private List<EventOpsRecoverySnapshot> RecoveryRows = [];

    private bool DivisionsLocked;
    private bool FormatAndRulesLocked;
    private bool RegistrationDeadlineSet;
    private string RegistrationDeadlineLocal = DateTime.Now.AddDays(2).ToString("yyyy-MM-ddTHH:mm");
    private EventOpsSeedingStrategy SeedingStrategy = EventOpsSeedingStrategy.RankingsSeeded;
    private bool ContingencyPrintReady;
    private bool WeighInsCompleted;
    private bool ScratchListFrozen;
    private bool HeadTableReady;
    private bool MatTablesReady;
    private bool QrPostedForLiveResults;
    private bool FinalResultsLocked;
    private bool PlacingsExported;
    private bool TeamPointsExported;
    private bool AwardSheetsPrinted;
    private bool FinalBracketsPublished;
    private bool RequireScratchFreezeForBracketGeneration = true;
    private string Notes = string.Empty;

    private Guid? SelectedEventId =>
        Guid.TryParse(SelectedEventIdText, out var eventId) ? eventId : null;

    private string SelectedBracketsHref =>
        SelectedEventId is null ? "/brackets" : $"/brackets?eventId={SelectedEventId.Value:D}";

    private string SelectedTableWorkerHref =>
        SelectedEventId is null ? "/table-worker" : $"/table-worker?eventId={SelectedEventId.Value:D}";

    protected override async Task OnInitializedAsync()
    {
        if (Workflow.EventId is not null)
        {
            SelectedEventIdText = Workflow.EventId.Value.ToString();
        }

        if (EventId is not null)
        {
            SelectedEventIdText = EventId.Value.ToString();
            Workflow.EventId = EventId.Value;
        }

        await LoadEventsAsync();
        if (SelectedEventId is not null)
        {
            await LoadChecklistAsync();
        }
    }

    private async Task LoadEventsAsync()
    {
        IsBusy = true;
        try
        {
            var events = await ApiClient.GetTableWorkerEventsAsync(StateFilter, 365);
            if (!events.Success)
            {
                StatusSuccess = false;
                StatusMessage = events.Message;
                Events = [];
                return;
            }

            Events = events.Data ?? [];
            if (string.IsNullOrWhiteSpace(SelectedEventIdText) && Events.Count > 0)
            {
                SelectedEventIdText = Events[0].EventId.ToString();
            }

            StatusSuccess = true;
            StatusMessage = $"Loaded {Events.Count} events.";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private void UseWorkflowEvent()
    {
        if (Workflow.EventId is null)
        {
            StatusSuccess = false;
            StatusMessage = "Workflow event is empty.";
            return;
        }

        SelectedEventIdText = Workflow.EventId.Value.ToString();
        StatusSuccess = true;
        StatusMessage = $"Using workflow event {Short(Workflow.EventId.Value)}.";
    }

    private async Task LoadChecklistAsync()
    {
        if (SelectedEventId is null)
        {
            StatusSuccess = false;
            StatusMessage = "Select a valid event first.";
            return;
        }

        IsBusy = true;
        try
        {
            Workflow.EventId = SelectedEventId.Value;
            var checklist = await ApiClient.GetEventOpsChecklistAsync(SelectedEventId.Value);
            if (!checklist.Success || checklist.Data is null)
            {
                StatusSuccess = false;
                StatusMessage = checklist.Message;
                Checklist = null;
                return;
            }

            Checklist = checklist.Data;
            HydrateDraft(Checklist);
            await LoadArtifactLinksAsync();
            await LoadRecoveryAsync();

            StatusSuccess = true;
            StatusMessage = "Checklist loaded.";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task SaveChecklistAsync()
    {
        if (SelectedEventId is null)
        {
            StatusSuccess = false;
            StatusMessage = "Select a valid event first.";
            return;
        }

        DateTime? registrationDeadlineUtc = null;
        if (RegistrationDeadlineSet && DateTime.TryParse(RegistrationDeadlineLocal, out var parsed))
        {
            registrationDeadlineUtc = DateTime.SpecifyKind(parsed, DateTimeKind.Local).ToUniversalTime();
        }

        IsBusy = true;
        try
        {
            var request = new UpdateEventOpsChecklistRequest(
                DivisionsLocked,
                FormatAndRulesLocked,
                RegistrationDeadlineSet,
                registrationDeadlineUtc,
                SeedingStrategy,
                ContingencyPrintReady,
                WeighInsCompleted,
                ScratchListFrozen,
                HeadTableReady,
                MatTablesReady,
                QrPostedForLiveResults,
                FinalResultsLocked,
                PlacingsExported,
                TeamPointsExported,
                AwardSheetsPrinted,
                FinalBracketsPublished,
                RequireScratchFreezeForBracketGeneration,
                Notes);

            var updated = await ApiClient.UpdateEventOpsChecklistAsync(SelectedEventId.Value, request);
            if (!updated.Success || updated.Data is null)
            {
                StatusSuccess = false;
                StatusMessage = updated.Message;
                return;
            }

            Checklist = updated.Data;
            HydrateDraft(Checklist);
            await LoadRecoveryAsync();
            StatusSuccess = true;
            StatusMessage = "Checklist saved.";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task LoadArtifactLinksAsync()
    {
        if (SelectedEventId is null)
        {
            return;
        }

        var links = await ApiClient.GetEventOpsArtifactsAsync(SelectedEventId.Value);
        ArtifactLinks = links.Success ? links.Data : null;
    }

    private async Task LoadRecoveryAsync()
    {
        if (SelectedEventId is null)
        {
            return;
        }

        var recovery = await ApiClient.GetEventOpsRecoveryAsync(SelectedEventId.Value);
        RecoveryRows = recovery.Success && recovery.Data is not null
            ? recovery.Data
            : [];
    }

    private void HydrateDraft(EventOpsChecklistState state)
    {
        DivisionsLocked = state.DivisionsLocked;
        FormatAndRulesLocked = state.FormatAndRulesLocked;
        RegistrationDeadlineSet = state.RegistrationDeadlineSet;
        RegistrationDeadlineLocal = (state.RegistrationDeadlineUtc ?? DateTime.UtcNow.AddDays(2)).ToLocalTime().ToString("yyyy-MM-ddTHH:mm");
        SeedingStrategy = state.SeedingStrategy;
        ContingencyPrintReady = state.ContingencyPrintReady;
        WeighInsCompleted = state.WeighInsCompleted;
        ScratchListFrozen = state.ScratchListFrozen;
        HeadTableReady = state.HeadTableReady;
        MatTablesReady = state.MatTablesReady;
        QrPostedForLiveResults = state.QrPostedForLiveResults;
        FinalResultsLocked = state.FinalResultsLocked;
        PlacingsExported = state.PlacingsExported;
        TeamPointsExported = state.TeamPointsExported;
        AwardSheetsPrinted = state.AwardSheetsPrinted;
        FinalBracketsPublished = state.FinalBracketsPublished;
        RequireScratchFreezeForBracketGeneration = state.RequireScratchFreezeForBracketGeneration;
        Notes = state.Notes ?? string.Empty;
    }

    private static string Short(Guid value) => value.ToString("N")[..8];
    private static string Short(Guid? value) => value is null ? "-" : Short(value.Value);
    private static string FormatClock(int seconds) => TimeSpan.FromSeconds(Math.Max(0, seconds)).ToString(@"mm\:ss");
}
