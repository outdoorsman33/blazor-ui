@page "/tournaments"
@inject PlatformApiClient ApiClient
@inject WorkflowState Workflow

<PageTitle>Tournaments - PinPoint Arena</PageTitle>

<div class="page-head">
    <div>
        <h1 class="page-title">Tournament Explorer</h1>
        <p class="page-subtitle">Browse live, upcoming, and archived tournaments with quick entry to registration, brackets, scoring, and streams.</p>
    </div>
    <div class="tag-row">
        <span class="tag">Live + Upcoming + Past</span>
        <span class="tag">Archive-Ready</span>
        <span class="tag">State Filter</span>
    </div>
</div>

<section class="panel">
    <h2>Filters</h2>
    <div class="form-grid spacer-top">
        <div class="field">
            <label>State</label>
            <select class="select" @bind="StateFilter">
                @foreach (var state in FormOptions.UsStatesWithAny)
                {
                    <option value="@state.Code">@state.Name</option>
                }
            </select>
        </div>
        <div class="field">
            <label>Days Back</label>
            <input class="input" type="number" min="7" max="730" @bind="DaysBack" />
        </div>
        <div class="field">
            <label>Days Ahead</label>
            <input class="input" type="number" min="7" max="730" @bind="DaysAhead" />
        </div>
    </div>
    <div class="actions">
        <button class="btn primary" @onclick="LoadExplorerAsync" disabled="@IsBusy">Load Tournaments</button>
        <button class="btn ghost" @onclick="UseWorkflowEvent">Use Workflow Event</button>
    </div>

    @if (!string.IsNullOrWhiteSpace(StatusMessage))
    {
        <div class="alert @(StatusSuccess ? "success" : "error") spacer-top">@StatusMessage</div>
    }
</section>

@if (Explorer is not null)
{
    <div class="panel-grid three spacer-top">
        <section class="panel">
            <div class="item-head">
                <h2>Live</h2>
                <span class="tag">@Explorer.Live.Count</span>
            </div>
            @if (Explorer.Live.Count == 0)
            {
                <p class="helper spacer-top">No live tournaments right now.</p>
            }
            else
            {
                <ul class="list spacer-top">
                    @foreach (var card in Explorer.Live.Take(16))
                    {
                        <li class="list-item">
                            <div class="item-head">
                                <span class="item-title">@card.Name</span>
                                <span class="item-meta">@card.City, @card.State</span>
                            </div>
                            <div class="helper spacer-top">@card.StartUtc.ToLocalTime():MMM dd, yyyy h:mm tt - @card.EndUtc.ToLocalTime():MMM dd, yyyy h:mm tt</div>
                            <div class="split spacer-top">
                                <span>Style: @card.Style</span>
                                <span>Registrants: @card.RegisteredAthletes</span>
                                <span>Active Mats: @card.ActiveMats</span>
                                <span>Streams: @card.LiveStreams</span>
                                <span>Completed: @card.CompletedMatches</span>
                            </div>
                            @if (Workflow.EventId == card.EventId)
                            {
                                <div class="tag spacer-top">Workflow Selected</div>
                            }
                            <div class="actions">
                                <a class="btn secondary" href="@RegistrationRoute(card.EventId)">Register</a>
                                <a class="btn ghost" href="@BracketsRoute(card.EventId)">Brackets</a>
                                <a class="btn ghost" href="@LiveRoute(card.EventId)">Live</a>
                            </div>
                        </li>
                    }
                </ul>
            }
        </section>

        <section class="panel">
            <div class="item-head">
                <h2>Upcoming</h2>
                <span class="tag">@Explorer.Upcoming.Count</span>
            </div>
            @if (Explorer.Upcoming.Count == 0)
            {
                <p class="helper spacer-top">No upcoming tournaments in this window.</p>
            }
            else
            {
                <ul class="list spacer-top">
                    @foreach (var card in Explorer.Upcoming.Take(16))
                    {
                        <li class="list-item">
                            <div class="item-head">
                                <span class="item-title">@card.Name</span>
                                <span class="item-meta">@card.City, @card.State</span>
                            </div>
                            <div class="helper spacer-top">@card.StartUtc.ToLocalTime():MMM dd, yyyy h:mm tt - @card.EndUtc.ToLocalTime():MMM dd, yyyy h:mm tt</div>
                            <div class="split spacer-top">
                                <span>Style: @card.Style</span>
                                <span>Registrants: @card.RegisteredAthletes</span>
                                <span>Active Mats: @card.ActiveMats</span>
                                <span>Streams: @card.LiveStreams</span>
                                <span>Completed: @card.CompletedMatches</span>
                            </div>
                            @if (Workflow.EventId == card.EventId)
                            {
                                <div class="tag spacer-top">Workflow Selected</div>
                            }
                            <div class="actions">
                                <a class="btn secondary" href="@RegistrationRoute(card.EventId)">Register</a>
                                <a class="btn ghost" href="@BracketsRoute(card.EventId)">Brackets</a>
                                <a class="btn ghost" href="@LiveRoute(card.EventId)">Live</a>
                            </div>
                        </li>
                    }
                </ul>
            }
        </section>

        <section class="panel">
            <div class="item-head">
                <h2>Archive</h2>
                <span class="tag">@Explorer.Past.Count</span>
            </div>
            @if (Explorer.Past.Count == 0)
            {
                <p class="helper spacer-top">No archived tournaments in this window.</p>
            }
            else
            {
                <ul class="list spacer-top">
                    @foreach (var card in Explorer.Past.Take(16))
                    {
                        <li class="list-item">
                            <div class="item-head">
                                <span class="item-title">@card.Name</span>
                                <span class="item-meta">@card.City, @card.State</span>
                            </div>
                            <div class="helper spacer-top">@card.StartUtc.ToLocalTime():MMM dd, yyyy h:mm tt - @card.EndUtc.ToLocalTime():MMM dd, yyyy h:mm tt</div>
                            <div class="split spacer-top">
                                <span>Style: @card.Style</span>
                                <span>Registrants: @card.RegisteredAthletes</span>
                                <span>Active Mats: @card.ActiveMats</span>
                                <span>Streams: @card.LiveStreams</span>
                                <span>Completed: @card.CompletedMatches</span>
                            </div>
                            @if (Workflow.EventId == card.EventId)
                            {
                                <div class="tag spacer-top">Workflow Selected</div>
                            }
                            <div class="actions">
                                <a class="btn secondary" href="@RegistrationRoute(card.EventId)">Register</a>
                                <a class="btn ghost" href="@BracketsRoute(card.EventId)">Brackets</a>
                                <a class="btn ghost" href="@LiveRoute(card.EventId)">Live</a>
                            </div>
                        </li>
                    }
                </ul>
            }
        </section>
    </div>
}

@code {
    private bool IsBusy;
    private bool StatusSuccess;
    private string? StatusMessage;
    private string StateFilter = "OH";
    private int DaysBack = 180;
    private int DaysAhead = 180;
    private TournamentExplorerResponse? Explorer;

    protected override async Task OnInitializedAsync()
    {
        await LoadExplorerAsync();
    }

    private async Task LoadExplorerAsync()
    {
        IsBusy = true;
        try
        {
            var result = await ApiClient.GetTournamentExplorerAsync(
                DaysBack,
                DaysAhead,
                string.IsNullOrWhiteSpace(StateFilter) ? null : StateFilter.Trim().ToUpperInvariant());

            if (!result.Success || result.Data is null)
            {
                StatusSuccess = false;
                StatusMessage = result.Message;
                Explorer = null;
                return;
            }

            Explorer = result.Data;
            StatusSuccess = true;
            StatusMessage = $"Loaded {Explorer.Live.Count + Explorer.Upcoming.Count + Explorer.Past.Count} tournaments.";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private void UseWorkflowEvent()
    {
        if (Workflow.EventId is null || Explorer is null)
        {
            return;
        }

        var all = Explorer.Live.Concat(Explorer.Upcoming).Concat(Explorer.Past).ToList();
        var selected = all.FirstOrDefault(x => x.EventId == Workflow.EventId.Value);
        StatusSuccess = selected is not null;
        StatusMessage = selected is null
            ? "Workflow event is not visible in the current filter window."
            : $"Workflow event loaded: {selected.Name} ({selected.State}/{selected.City}).";
    }

    private static string RegistrationRoute(Guid eventId) => $"/registration?eventId={eventId:D}";

    private static string BracketsRoute(Guid eventId) => $"/brackets?eventId={eventId:D}";

    private static string LiveRoute(Guid eventId) => $"/live?eventId={eventId:D}";
}
