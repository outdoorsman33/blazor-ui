@page "/support"
@inject PlatformApiClient ApiClient

<PageTitle>Support - PinPoint Arena</PageTitle>

<div class="page-head">
    <div>
        <h1 class="page-title">Support Center</h1>
        <p class="page-subtitle">Searchable FAQs, step-by-step playbooks, and an in-app assistant to guide every workflow.</p>
    </div>
    <div class="tag-row">
        <a class="tag" href="#faq-search">FAQ Search</a>
        <a class="tag" href="#guided-steps">Guided Steps</a>
        <a class="tag" href="#help-assistant">Help Assistant</a>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(StatusMessage))
{
    <div class="alert @(StatusSuccess ? "success" : "error")">@StatusMessage</div>
}

<div class="panel-grid two">
    <section id="faq-search" class="panel">
        <div class="item-head">
            <h2>FAQ Search</h2>
            <button class="btn ghost" @onclick="LoadFaqsAsync" disabled="@IsBusy">Refresh</button>
        </div>
        <form method="get" action="/support">
            <div class="form-grid spacer-top">
                <div class="field">
                    <label>Search FAQs</label>
                    <input class="input"
                           name="faq"
                           @bind="FaqQuery"
                           @bind:event="oninput"
                           @onkeydown="OnFaqKeyDownAsync"
                           placeholder="registration, scoring, stream, nil..." />
                </div>
            </div>
            <div class="actions">
                <button class="btn primary" @onclick="SearchFaqsAsync" disabled="@IsBusy" type="button">Search FAQs</button>
                <button class="btn ghost" type="submit">Search via URL</button>
            </div>
        </form>
        <ul class="list spacer-top">
            @if (Faqs.Count == 0)
            {
                <li class="list-item">No FAQs loaded.</li>
            }
            else
            {
                @foreach (var item in Faqs)
                {
                    <li class="list-item support-faq-item">
                        <a class="support-faq-link" href="@FaqRoute(item.Id)">
                            <div class="item-head">
                                <span class="item-title">@item.Question</span>
                                <span class="tag">@item.Category</span>
                            </div>
                            <div class="helper spacer-top">@item.Answer</div>
                        </a>
                        <div class="actions support-faq-actions">
                            <a class="btn ghost" href="@FaqRoute(item.Id)">Open FAQ</a>
                            <a class="btn ghost" href="@ResolveRouteForCategory(item.Category)">Open Workflow</a>
                        </div>
                    </li>
                }
            }
        </ul>
    </section>

    <section id="guided-steps" class="panel">
        <div class="item-head">
            <h2>Step-by-Step Guide</h2>
            <button class="btn ghost" @onclick="LoadGuideAsync" disabled="@IsBusy">Reload</button>
        </div>
        <div class="timeline spacer-top">
            @if (GuideSteps.Count == 0)
            {
                <div class="timeline-item">No guide steps loaded yet.</div>
            }
            else
            {
                @foreach (var step in GuideSteps.OrderBy(x => x.StepNumber))
                {
                    <div class="timeline-item">
                        <strong>@step.StepNumber. @step.Title</strong>
                        <div class="helper spacer-top">@step.Description</div>
                        <div class="actions">
                            <a class="btn secondary" href="@step.Route">@step.ActionLabel</a>
                        </div>
                    </div>
                }
            }
        </div>
    </section>
</div>

<section id="help-assistant" class="panel spacer-top">
    <h2>Help Assistant</h2>
    <p class="helper">Ask questions in plain language. The assistant routes you to the right workflow and FAQs.</p>

    <form method="get" action="/support">
        <div class="form-grid spacer-top">
            <div class="field">
                <label>Your Question</label>
                <input class="input"
                       name="ask"
                       @bind="ChatMessage"
                       @bind:event="oninput"
                       @onkeydown="OnChatKeyDownAsync"
                       placeholder="How do I score overtime matches?" />
            </div>
            <div class="field">
                <label>Context (optional)</label>
                <input class="input" name="context" @bind="ChatContext" placeholder="event admin, table worker, coach..." />
            </div>
        </div>

        <div class="actions">
            <button class="btn primary" @onclick="AskAssistantAsync" disabled="@IsBusy" type="button">Ask Assistant</button>
            <button class="btn ghost" type="submit">Ask via URL</button>
        </div>
    </form>

    @if (ChatResponse is not null)
    {
        <div class="list spacer-top">
            <div class="list-item">
                <div class="item-title">Assistant Reply</div>
                <div class="helper spacer-top">@ChatResponse.Reply</div>
            </div>
            @if (ChatResponse.SuggestedActions.Count > 0)
            {
                <div class="list-item">
                    <div class="item-title">Suggested Actions</div>
                    <div class="list spacer-top">
                        @foreach (var action in ChatResponse.SuggestedActions)
                        {
                            <a class="assistant-action-link" href="@ResolveRouteForAction(action)">
                                <span class="assistant-action-title">@action</span>
                                <span class="assistant-action-open">Open</span>
                            </a>
                        }
                    </div>
                </div>
            }
            @if (ChatResponse.SuggestedFaqIds.Count > 0)
            {
                <div class="list-item">
                    <div class="item-title">Related FAQs</div>
                    <div class="list spacer-top">
                        @foreach (var faq in ResolveSuggestedFaqs(ChatResponse.SuggestedFaqIds))
                        {
                            <a class="assistant-faq-link" href="@FaqRoute(faq.Id)">
                                <span class="assistant-faq-title">@faq.Question</span>
                                <span class="assistant-faq-meta">@faq.Category</span>
                            </a>
                        }
                    </div>
                </div>
            }
        </div>
    }
</section>

@code {
    [SupplyParameterFromQuery(Name = "faq")]
    public string? FaqQueryParam { get; set; }

    [SupplyParameterFromQuery(Name = "faqId")]
    public string? FaqIdParam { get; set; }

    [SupplyParameterFromQuery(Name = "ask")]
    public string? AskParam { get; set; }

    [SupplyParameterFromQuery(Name = "context")]
    public string? AskContextParam { get; set; }

    private bool IsBusy;
    private bool StatusSuccess;
    private string? StatusMessage;
    private string FaqQuery = string.Empty;
    private List<HelpFaqItem> Faqs = [];
    private List<HelpFaqItem> AllFaqs = [];
    private List<SupportGuideStep> GuideSteps = [];
    private string ChatMessage = string.Empty;
    private string ChatContext = string.Empty;
    private HelpChatResponse? ChatResponse;
    private string? LastFaqQueryParamHandled;
    private string? LastFaqIdParamHandled;
    private string? LastAskCompositeHandled;

    protected override async Task OnInitializedAsync()
    {
        await LoadFaqsAsync();
        await LoadGuideAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.Equals(LastFaqQueryParamHandled, FaqQueryParam, StringComparison.Ordinal))
        {
            LastFaqQueryParamHandled = FaqQueryParam;
            if (!string.IsNullOrWhiteSpace(FaqQueryParam))
            {
                FaqQuery = FaqQueryParam;
                await SearchFaqsAsync();
            }
        }

        if (!string.Equals(LastFaqIdParamHandled, FaqIdParam, StringComparison.OrdinalIgnoreCase))
        {
            LastFaqIdParamHandled = FaqIdParam;
            if (!string.IsNullOrWhiteSpace(FaqIdParam))
            {
                await OpenFaqAsync(FaqIdParam);
            }
        }

        var askComposite = $"{AskParam ?? string.Empty}|{AskContextParam ?? string.Empty}";
        if (!string.Equals(LastAskCompositeHandled, askComposite, StringComparison.Ordinal))
        {
            LastAskCompositeHandled = askComposite;
            if (!string.IsNullOrWhiteSpace(AskParam))
            {
                ChatMessage = AskParam;
                ChatContext = AskContextParam ?? string.Empty;
                await AskAssistantAsync();
            }
        }
    }

    private async Task OnFaqKeyDownAsync(KeyboardEventArgs args)
    {
        if (string.Equals(args.Key, "Enter", StringComparison.OrdinalIgnoreCase))
        {
            await SearchFaqsAsync();
        }
    }

    private async Task LoadFaqsAsync()
    {
        IsBusy = true;
        try
        {
            var result = await ApiClient.GetHelpFaqsAsync();
            if (!result.Success)
            {
                StatusSuccess = false;
                StatusMessage = result.Message;
                Faqs = [];
                return;
            }

            Faqs = result.Data ?? [];
            if (string.IsNullOrWhiteSpace(FaqQuery))
            {
                AllFaqs = [.. Faqs];
            }
            StatusSuccess = true;
            StatusMessage = $"Loaded {Faqs.Count} FAQs.";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task SearchFaqsAsync()
    {
        IsBusy = true;
        try
        {
            var result = await ApiClient.GetHelpFaqsAsync(FaqQuery);
            if (!result.Success)
            {
                StatusSuccess = false;
                StatusMessage = result.Message;
                Faqs = [];
                return;
            }

            Faqs = result.Data ?? [];
            StatusSuccess = true;
            StatusMessage = $"Found {Faqs.Count} FAQ results.";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task LoadGuideAsync()
    {
        IsBusy = true;
        try
        {
            var result = await ApiClient.GetSupportGuideAsync();
            if (!result.Success)
            {
                StatusSuccess = false;
                StatusMessage = result.Message;
                GuideSteps = [];
                return;
            }

            GuideSteps = result.Data ?? [];
            StatusSuccess = true;
            StatusMessage = $"Loaded {GuideSteps.Count} guide steps.";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task AskAssistantAsync()
    {
        if (string.IsNullOrWhiteSpace(ChatMessage))
        {
            StatusSuccess = false;
            StatusMessage = "Ask a question first.";
            return;
        }

        IsBusy = true;
        try
        {
            var result = await ApiClient.AskHelpAssistantAsync(new HelpChatRequest(ChatMessage, ChatContext));
            if (!result.Success || result.Data is null)
            {
                StatusSuccess = false;
                StatusMessage = result.Message;
                ChatResponse = null;
                return;
            }

            ChatResponse = result.Data;
            if (AllFaqs.Count == 0)
            {
                var faqResult = await ApiClient.GetHelpFaqsAsync();
                if (faqResult.Success)
                {
                    AllFaqs = faqResult.Data ?? [];
                }
            }
            StatusSuccess = true;
            StatusMessage = "Assistant response ready.";
        }
        finally
        {
            IsBusy = false;
        }
    }

    private async Task OnChatKeyDownAsync(KeyboardEventArgs args)
    {
        if (string.Equals(args.Key, "Enter", StringComparison.OrdinalIgnoreCase))
        {
            await AskAssistantAsync();
        }
    }

    private async Task OpenFaqAsync(string faqId)
    {
        var result = await ApiClient.GetHelpFaqsAsync();
        if (!result.Success)
        {
            StatusSuccess = false;
            StatusMessage = result.Message;
            return;
        }

        var allFaqs = result.Data ?? [];
        var matched = allFaqs.FirstOrDefault(x => string.Equals(x.Id, faqId, StringComparison.OrdinalIgnoreCase));
        if (matched is null)
        {
            StatusSuccess = false;
            StatusMessage = $"FAQ id '{faqId}' was not found.";
            return;
        }

        Faqs = [matched];
        StatusSuccess = true;
        StatusMessage = $"Showing FAQ: {matched.Question}";
    }

    private List<HelpFaqItem> ResolveSuggestedFaqs(List<string> faqIds)
    {
        if (faqIds.Count == 0)
        {
            return [];
        }

        var merged = AllFaqs.Count > 0 ? AllFaqs : Faqs;
        var resolved = new List<HelpFaqItem>(faqIds.Count);
        foreach (var faqId in faqIds.Distinct(StringComparer.OrdinalIgnoreCase))
        {
            var match = merged.FirstOrDefault(x => string.Equals(x.Id, faqId, StringComparison.OrdinalIgnoreCase));
            if (match is null)
            {
                resolved.Add(new HelpFaqItem(faqId, "Support", faqId, "Open this FAQ entry in Support Center.", []));
                continue;
            }

            resolved.Add(match);
        }

        return resolved;
    }

    private static string ResolveRouteForCategory(string category)
    {
        var normalized = category.Trim().ToLowerInvariant();

        if (normalized.Contains("registration"))
        {
            return "/registration";
        }

        if (normalized.Contains("bracket"))
        {
            return "/bracket-builder";
        }

        if (normalized.Contains("ops") || normalized.Contains("checklist") || normalized.Contains("recovery"))
        {
            return "/ops-checklist";
        }

        if (normalized.Contains("mat") || normalized.Contains("score"))
        {
            return "/mat-scoring";
        }

        if (normalized.Contains("table"))
        {
            return "/table-worker";
        }

        if (normalized.Contains("stream") || normalized.Contains("live"))
        {
            return "/live";
        }

        if (normalized.Contains("nil") || normalized.Contains("athlete"))
        {
            return "/athlete";
        }

        if (normalized.Contains("coach"))
        {
            return "/coach";
        }

        if (normalized.Contains("search") || normalized.Contains("discover"))
        {
            return "/search";
        }

        return "/support";
    }

    private static string ResolveRouteForAction(string action)
    {
        var normalized = action.Trim().ToLowerInvariant();

        if (normalized.Contains("registration") || normalized.Contains("register"))
        {
            return "/registration";
        }

        if (normalized.Contains("bracket"))
        {
            return "/bracket-builder";
        }

        if (normalized.Contains("ops") || normalized.Contains("checklist") || normalized.Contains("recovery"))
        {
            return "/ops-checklist";
        }

        if (normalized.Contains("score"))
        {
            return "/mat-scoring";
        }

        if (normalized.Contains("table"))
        {
            return "/table-worker";
        }

        if (normalized.Contains("stream") || normalized.Contains("live"))
        {
            return "/live";
        }

        if (normalized.Contains("nil") || normalized.Contains("athlete"))
        {
            return "/athlete";
        }

        if (normalized.Contains("coach"))
        {
            return "/coach";
        }

        if (normalized.Contains("search") || normalized.Contains("find"))
        {
            return "/search";
        }

        return "/support";
    }

    private static string FaqRoute(string faqId) => $"/support?faqId={Uri.EscapeDataString(faqId)}";
}
