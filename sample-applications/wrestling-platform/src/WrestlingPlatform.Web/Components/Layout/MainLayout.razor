@inherits LayoutComponentBase
@inject PlatformApiClient ApiClient
@inject AuthSession AuthSession
@inject WorkflowState Workflow
@inject NavigationManager Navigation

<div class="app-shell" @onclick="CloseSearchMenu">
    <div class="ambient ambient-left"></div>
    <div class="ambient ambient-right"></div>

    <header class="topbar" @onclick:stopPropagation="true">
        <div class="topbar-row">
            <div class="brand-block">
                <span class="brand-badge">USA Wrestling Platform</span>
                <a href="/" class="brand-link">PinPoint Arena</a>
            </div>

            <div class="global-search-shell">
                <input class="global-search-input"
                       value="@SearchText"
                       @oninput="OnSearchInputAsync"
                       @onkeydown="OnSearchKeyDown"
                       placeholder="Search athletes, tournaments, teams, coaches, matches..."
                       aria-label="Global Search" />
                <a class="global-search-btn" href="@FullSearchHref" @onclick="OnSearchLinkClick">Search</a>

                @if (SearchOpen)
                {
                    <div class="search-dropdown">
                        @if (!string.IsNullOrWhiteSpace(SearchStatus))
                        {
                            <div class="search-hint">@SearchStatus</div>
                        }
                        else if (SearchResults.Count == 0)
                        {
                            <div class="search-hint">No matches found.</div>
                        }
                        else
                        {
                            @foreach (var result in SearchResults)
                            {
                                <a class="search-item" href="@SearchResultHref(result)" @onclick="@(() => OnSearchResultClick(result))">
                                    <span class="search-title">@result.Title</span>
                                    <span class="search-meta">@result.Subtitle</span>
                                </a>
                            }
                            <a class="search-more" href="@FullSearchHref" @onclick="OnSearchLinkClick">Open full search page</a>
                        }
                    </div>
                }
            </div>

            <button class="nav-toggle" @onclick="ToggleNavMenu" aria-expanded="@NavMenuOpen">Menu</button>

            <div class="auth-panel">
                @if (!AuthSession.IsAuthenticated)
                {
                    <input class="mini-input" @bind="Email" placeholder="email" />
                    <input class="mini-input" @bind="Password" type="password" placeholder="password" />
                    <input class="mini-input mfa-input" @bind="MfaCode" placeholder="mfa (if required)" />
                    <button class="mini-btn" @onclick="SignInAsync" disabled="@Busy">Sign In</button>
                    <button class="mini-btn secondary" @onclick="SignInAsDemoAthleteAsync" disabled="@Busy">Demo Athlete</button>
                    <button class="mini-btn secondary" @onclick="SignInAsDemoCoachAsync" disabled="@Busy">Demo Coach</button>
                }
                else
                {
                    <div class="auth-chip">@AuthSession.Role | @AuthSession.Email</div>
                    <button class="mini-btn secondary" @onclick="SignOutAsync">Sign Out</button>
                }
            </div>
        </div>

        <nav class="main-nav @(NavMenuOpen ? "is-open" : string.Empty)" aria-label="Main navigation">
            <NavLink href="/" Match="NavLinkMatch.All">Command Center</NavLink>
            <NavLink href="/lab">Operations Lab</NavLink>
            <NavLink href="/tournaments">Tournaments</NavLink>
            <NavLink href="/registration">Registration</NavLink>
            <NavLink href="/brackets">Bracket Center</NavLink>
            <NavLink href="/table-worker">Table Worker</NavLink>
            <NavLink href="/mat-scoring">Mat Scoring</NavLink>
            <NavLink href="/live">Live Hub</NavLink>
            <NavLink href="/athlete">Athlete Portal</NavLink>
            <NavLink href="/coach">Coach Portal</NavLink>
            <NavLink href="/recruiting">Recruiting Hub</NavLink>
            <NavLink href="/admin">Event Admin</NavLink>
            <NavLink href="/support">Support</NavLink>
        </nav>
    </header>

    @if (!string.IsNullOrWhiteSpace(AuthMessage))
    {
        <div class="auth-message @(AuthOk ? "auth-ok" : "auth-error")">@AuthMessage</div>
    }

    @if (Workflow.TeamId is not null || Workflow.EventId is not null || Workflow.MatchId is not null || Workflow.AthleteProfileId is not null || Workflow.CoachProfileId is not null)
    {
        <div class="workflow-strip">
            <span class="workflow-chip">Athlete: @Short(Workflow.AthleteProfileId)</span>
            <span class="workflow-chip">Coach: @Short(Workflow.CoachProfileId)</span>
            <span class="workflow-chip">Team: @Short(Workflow.TeamId)</span>
            <span class="workflow-chip">Event: @Short(Workflow.EventId)</span>
            <span class="workflow-chip">Match: @Short(Workflow.MatchId)</span>
            <button class="mini-btn ghost" @onclick="ClearWorkflow">Clear Workflow</button>
        </div>
    }

    <main class="surface">
        @Body
    </main>

    <footer class="app-footer">
        <span>Built for K-6, Middle School, High School, and College competition workflows.</span>
    </footer>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">X</span>
</div>

@code {
    private bool Busy;
    private string Email = "";
    private string Password = "";
    private string MfaCode = "";
    private string? AuthMessage;
    private bool AuthOk;
    private string SearchText = string.Empty;
    private string? SearchStatus;
    private List<GlobalSearchResultItem> SearchResults = [];
    private bool SearchOpen;
    private bool NavMenuOpen;
    private string FullSearchHref => $"/search?q={Uri.EscapeDataString(SearchText.Trim())}";

    private async Task SignInAsync()
    {
        Busy = true;
        AuthMessage = null;

        var result = await ApiClient.LoginAsync(new LoginRequest(Email, Password, MfaCode));
        AuthOk = result.Success;
        AuthMessage = result.Success ? "Signed in." : result.Message;

        if (result.Success)
        {
            Password = string.Empty;
            MfaCode = string.Empty;
        }

        Busy = false;
    }

    private async Task SignInAsDemoAthleteAsync()
    {
        Email = "demo.athlete@pinpointarena.local";
        Password = "DemoPass!123";
        await SignInAsync();
    }

    private async Task SignInAsDemoCoachAsync()
    {
        Email = "demo.coach@pinpointarena.local";
        Password = "DemoPass!123";
        await SignInAsync();
    }

    private async Task SignOutAsync()
    {
        await ApiClient.LogoutAsync();
        AuthOk = true;
        AuthMessage = "Signed out.";
    }

    private void ToggleNavMenu() => NavMenuOpen = !NavMenuOpen;

    private async Task OnSearchInputAsync(ChangeEventArgs args)
    {
        SearchText = args.Value?.ToString() ?? string.Empty;
        var trimmed = SearchText.Trim();
        if (trimmed.Length < 2)
        {
            SearchResults = [];
            SearchStatus = trimmed.Length == 0 ? null : "Type at least 2 characters.";
            SearchOpen = trimmed.Length > 0;
            return;
        }

        SearchStatus = "Searching...";
        SearchOpen = true;
        var response = await ApiClient.SearchGlobalAsync(trimmed, 8);
        if (!response.Success || response.Data is null)
        {
            SearchResults = [];
            SearchStatus = response.Message;
            return;
        }

        SearchResults = response.Data.Results ?? [];
        SearchStatus = null;
    }

    private async Task OnSearchKeyDown(KeyboardEventArgs args)
    {
        if (string.Equals(args.Key, "Enter", StringComparison.OrdinalIgnoreCase))
        {
            await RunFullSearchAsync();
        }
    }

    private Task RunFullSearchAsync()
    {
        SearchOpen = false;
        NavMenuOpen = false;
        Navigation.NavigateTo(FullSearchHref);
        return Task.CompletedTask;
    }

    private Task OnSearchLinkClick()
    {
        SearchOpen = false;
        NavMenuOpen = false;
        return Task.CompletedTask;
    }

    private void OnSearchResultClick(GlobalSearchResultItem result)
    {
        SearchOpen = false;
        NavMenuOpen = false;
        ApplyWorkflowFromSearch(result);
    }

    private static string SearchResultHref(GlobalSearchResultItem result) => result.Type switch
    {
        GlobalSearchEntityType.Match => $"/mat-scoring?matchId={result.Id:D}",
        GlobalSearchEntityType.Tournament => $"/brackets?eventId={result.Id:D}",
        GlobalSearchEntityType.Athlete => "/athlete",
        GlobalSearchEntityType.Coach => "/coach",
        GlobalSearchEntityType.Stream => "/live",
        GlobalSearchEntityType.Team => "/coach",
        _ => "/search"
    };

    private void ApplyWorkflowFromSearch(GlobalSearchResultItem result)
    {
        switch (result.Type)
        {
            case GlobalSearchEntityType.Athlete:
                Workflow.AthleteProfileId = result.Id;
                break;
            case GlobalSearchEntityType.Tournament:
                Workflow.EventId = result.Id;
                break;
            case GlobalSearchEntityType.Match:
                Workflow.MatchId = result.Id;
                break;
            case GlobalSearchEntityType.Team:
                Workflow.TeamId = result.Id;
                break;
            case GlobalSearchEntityType.Coach:
                Workflow.CoachProfileId = result.Id;
                break;
        }
    }

    private void CloseSearchMenu()
    {
        SearchOpen = false;
    }

    private void ClearWorkflow() => Workflow.Clear();

    private static string Short(Guid? id)
    {
        return id is null ? "-" : id.Value.ToString()[..8];
    }
}
