@inherits LayoutComponentBase
@inject PlatformApiClient ApiClient
@inject AuthSession AuthSession
@inject WorkflowState Workflow

<div class="app-shell">
    <div class="ambient ambient-left"></div>
    <div class="ambient ambient-right"></div>

    <header class="topbar">
        <div class="brand-block">
            <span class="brand-badge">USA Wrestling Platform</span>
            <a href="/" class="brand-link">PinPoint Arena</a>
        </div>

        <nav class="main-nav" aria-label="Main navigation">
            <NavLink href="/" Match="NavLinkMatch.All">Command Center</NavLink>
            <NavLink href="/lab">Operations Lab</NavLink>
            <NavLink href="/registration">Registration</NavLink>
            <NavLink href="/brackets">Bracket Center</NavLink>
            <NavLink href="/table-worker">Table Worker</NavLink>
            <NavLink href="/live">Live Hub</NavLink>
            <NavLink href="/athlete">Athlete Portal</NavLink>
            <NavLink href="/coach">Coach Portal</NavLink>
            <NavLink href="/admin">Event Admin</NavLink>
            <NavLink href="/mat-scoring">Mat Scoring</NavLink>
            <NavLink href="/recruiting">Recruiting Hub</NavLink>
        </nav>

        <div class="auth-panel">
            @if (!AuthSession.IsAuthenticated)
            {
                <input class="mini-input" @bind="Email" placeholder="email" />
                <input class="mini-input" @bind="Password" type="password" placeholder="password" />
                <button class="mini-btn" @onclick="SignInAsync" disabled="@Busy">Sign In</button>
                <button class="mini-btn secondary" @onclick="SignInAsDemoAthleteAsync" disabled="@Busy">Demo Athlete</button>
                <button class="mini-btn secondary" @onclick="SignInAsDemoCoachAsync" disabled="@Busy">Demo Coach</button>
            }
            else
            {
                <div class="auth-chip">@AuthSession.Role | @AuthSession.Email</div>
                <button class="mini-btn secondary" @onclick="SignOutAsync">Sign Out</button>
            }
        </div>
    </header>

    @if (!string.IsNullOrWhiteSpace(AuthMessage))
    {
        <div class="auth-message @(AuthOk ? "auth-ok" : "auth-error")">@AuthMessage</div>
    }

    @if (Workflow.TeamId is not null || Workflow.EventId is not null || Workflow.MatchId is not null || Workflow.AthleteProfileId is not null || Workflow.CoachProfileId is not null)
    {
        <div class="workflow-strip">
            <span class="workflow-chip">Athlete: @Short(Workflow.AthleteProfileId)</span>
            <span class="workflow-chip">Coach: @Short(Workflow.CoachProfileId)</span>
            <span class="workflow-chip">Team: @Short(Workflow.TeamId)</span>
            <span class="workflow-chip">Event: @Short(Workflow.EventId)</span>
            <span class="workflow-chip">Match: @Short(Workflow.MatchId)</span>
            <button class="mini-btn ghost" @onclick="ClearWorkflow">Clear Workflow</button>
        </div>
    }

    <main class="surface">
        @Body
    </main>

    <footer class="app-footer">
        <span>Built for K-6, Middle School, High School, and College competition workflows.</span>
    </footer>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">X</span>
</div>

@code {
    private bool Busy;
    private string Email = "";
    private string Password = "";
    private string? AuthMessage;
    private bool AuthOk;

    private async Task SignInAsync()
    {
        Busy = true;
        AuthMessage = null;

        var result = await ApiClient.LoginAsync(new LoginRequest(Email, Password));
        AuthOk = result.Success;
        AuthMessage = result.Success ? "Signed in." : result.Message;

        if (result.Success)
        {
            Password = string.Empty;
        }

        Busy = false;
    }

    private async Task SignInAsDemoAthleteAsync()
    {
        Email = "demo.athlete@pinpointarena.local";
        Password = "DemoPass!123";
        await SignInAsync();
    }

    private async Task SignInAsDemoCoachAsync()
    {
        Email = "demo.coach@pinpointarena.local";
        Password = "DemoPass!123";
        await SignInAsync();
    }

    private async Task SignOutAsync()
    {
        await ApiClient.LogoutAsync();
        AuthOk = true;
        AuthMessage = "Signed out.";
    }

    private void ClearWorkflow() => Workflow.Clear();

    private static string Short(Guid? id)
    {
        return id is null ? "-" : id.Value.ToString()[..8];
    }
}

