@inherits LayoutComponentBase
@implements IDisposable
@inject PlatformApiClient ApiClient
@inject AuthSession AuthSession
@inject WorkflowState Workflow
@inject NavigationManager Navigation

<div class="app-shell" @onclick="CloseSearchMenu">
    <div class="ambient ambient-left"></div>
    <div class="ambient ambient-right"></div>

    <MudBreakpointProvider OnBreakpointChanged="OnBreakpointChanged" />

    <MudLayout Class="mud-layout-shell">
        <MudAppBar Elevation="2" Class="topbar mud-topbar" @onclick:stopPropagation="true">
            <MudIconButton Icon="@DrawerToggleIcon"
                           Color="Color.Inherit"
                           Edge="Edge.Start"
                           Class="drawer-toggle"
                           aria-label="@DrawerToggleAriaLabel"
                           OnClick="ToggleDrawer" />

            <div class="brand-block">
                <span class="brand-badge">USA Wrestling Platform</span>
                <a href="/" class="brand-link" @onclick="CloseDrawer">PinPoint Arena</a>
            </div>

            <MudHidden Breakpoint="Breakpoint.MdAndDown">
                <div class="global-search-shell">
                    <input class="global-search-input"
                           value="@SearchText"
                           @oninput="OnSearchInputAsync"
                           @onkeydown="OnSearchKeyDown"
                           placeholder="Search athletes, tournaments, teams, coaches, matches..."
                           aria-label="Global Search" />
                    <a class="global-search-btn" href="@FullSearchHref" @onclick="OnSearchLinkClick">Search</a>

                    @if (SearchOpen)
                    {
                        <div class="search-dropdown">
                            @if (!string.IsNullOrWhiteSpace(SearchStatus))
                            {
                                <div class="search-hint">@SearchStatus</div>
                            }
                            else if (SearchResults.Count == 0)
                            {
                                <div class="search-hint">No matches found.</div>
                            }
                            else
                            {
                                @foreach (var result in SearchResults)
                                {
                                    <a class="search-item" href="@SearchResultHref(result)" @onclick="@(() => OnSearchResultClick(result))">
                                        <span class="search-title">@result.Title</span>
                                        <span class="search-meta">@result.Subtitle</span>
                                    </a>
                                }
                                <a class="search-more" href="@FullSearchHref" @onclick="OnSearchLinkClick">Open full search page</a>
                            }
                        </div>
                    }
                </div>
            </MudHidden>

            <MudSpacer />

            <MudHidden Breakpoint="Breakpoint.MdAndDown">
                <div class="auth-panel">
                    @if (!AuthSession.IsAuthenticated)
                    {
                        <input class="mini-input" @bind="Email" placeholder="email" />
                        <input class="mini-input" @bind="Password" type="password" placeholder="password" />
                        <input class="mini-input mfa-input" @bind="MfaCode" placeholder="mfa (if required)" />
                        <button class="mini-btn" @onclick="SignInAsync" disabled="@Busy">Sign In</button>
                        <button class="mini-btn secondary" @onclick="SignInAsDemoAthleteAsync" disabled="@Busy">Demo Athlete</button>
                        <button class="mini-btn secondary" @onclick="SignInAsDemoCoachAsync" disabled="@Busy">Demo Coach</button>
                    }
                    else
                    {
                        <div class="auth-chip">@AuthSession.Role | @AuthSession.Email</div>
                        <button class="mini-btn secondary" @onclick="SignOutAsync">Sign Out</button>
                    }
                </div>
            </MudHidden>

            <MudHidden Breakpoint="Breakpoint.LgAndUp">
                <div class="mobile-appbar-actions">
                    <a class="mini-btn secondary" href="/search" @onclick="CloseDrawer">Search</a>
                    @if (!AuthSession.IsAuthenticated)
                    {
                        <button class="mini-btn secondary" @onclick="SignInAsDemoCoachAsync" disabled="@Busy">Demo Coach</button>
                    }
                    else
                    {
                        <button class="mini-btn secondary" @onclick="SignOutAsync">Sign Out</button>
                    }
                </div>
            </MudHidden>
        </MudAppBar>

        <MudDrawer @bind-Open="DrawerOpen"
                   Variant="@CurrentDrawerVariant"
                   Breakpoint="Breakpoint.Md"
                   Elevation="2"
                   ClipMode="@CurrentDrawerClipMode"
                   MiniWidth="78px"
                   OverlayAutoClose="true"
                   Class="main-drawer"
                   @onclick:stopPropagation="true">
            <div class="drawer-content">
                @if (ShowExpandedDrawerContent)
                {
                    <div class="drawer-brand">
                        <span class="brand-badge">Navigation</span>
                        <div class="item-title">PinPoint Arena</div>
                    </div>

                    <MudNavMenu Dense="true" Rounded="true" Class="drawer-nav">
                        <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Command Center</MudNavLink>
                        <MudNavLink Href="/lab" Icon="@Icons.Material.Filled.Psychology">Operations Lab</MudNavLink>
                        <MudNavLink Href="/tournaments" Icon="@Icons.Material.Filled.Event">Events</MudNavLink>
                        <MudNavLink Href="/registration" Icon="@Icons.Material.Filled.HowToReg">Registration</MudNavLink>
                        <MudNavLink Href="/brackets" Icon="@Icons.Material.Filled.AccountTree">Bracket Center</MudNavLink>
                        <MudNavLink Href="/bracket-builder" Icon="@Icons.Material.Filled.AutoFixHigh">Bracket Builder</MudNavLink>
                        <MudNavLink Href="/table-worker" Icon="@Icons.Material.Filled.TableRestaurant">Table Worker</MudNavLink>
                        <MudNavLink Href="/mat-scoring" Icon="@Icons.Material.Filled.Timer">Mat Scoring</MudNavLink>
                        <MudNavLink Href="/live" Icon="@Icons.Material.Filled.LiveTv">Live Hub</MudNavLink>
                        <MudNavLink Href="/athlete" Icon="@Icons.Material.Filled.Person">Athlete Portal</MudNavLink>
                        <MudNavLink Href="/coach" Icon="@Icons.Material.Filled.Groups">Coach Portal</MudNavLink>
                        <MudNavLink Href="/recruiting" Icon="@Icons.Material.Filled.School">Recruiting Hub</MudNavLink>
                        <MudNavLink Href="/admin" Icon="@Icons.Material.Filled.AdminPanelSettings">Event Admin</MudNavLink>
                        <MudNavLink Href="/support" Icon="@Icons.Material.Filled.SupportAgent">Support</MudNavLink>
                    </MudNavMenu>

                    <MudDivider Class="drawer-divider" />

                    <section class="drawer-tools">
                        <label class="drawer-label">Quick Search</label>
                        <div class="global-search-shell drawer-search-shell">
                            <input class="global-search-input"
                                   value="@SearchText"
                                   @oninput="OnSearchInputAsync"
                                   @onkeydown="OnSearchKeyDown"
                                   placeholder="athlete, event, team..."
                                   aria-label="Drawer Search" />
                            <a class="global-search-btn drawer-search-btn" href="@FullSearchHref" @onclick="OnSearchLinkClick">Search</a>

                            @if (SearchOpen)
                            {
                                <div class="search-dropdown">
                                    @if (!string.IsNullOrWhiteSpace(SearchStatus))
                                    {
                                        <div class="search-hint">@SearchStatus</div>
                                    }
                                    else if (SearchResults.Count == 0)
                                    {
                                        <div class="search-hint">No matches found.</div>
                                    }
                                    else
                                    {
                                        @foreach (var result in SearchResults)
                                        {
                                            <a class="search-item" href="@SearchResultHref(result)" @onclick="@(() => OnSearchResultClick(result))">
                                                <span class="search-title">@result.Title</span>
                                                <span class="search-meta">@result.Subtitle</span>
                                            </a>
                                        }
                                        <a class="search-more" href="@FullSearchHref" @onclick="OnSearchLinkClick">Open full search page</a>
                                    }
                                </div>
                            }
                        </div>
                    </section>

                    <MudDivider Class="drawer-divider" />

                    <section class="drawer-auth">
                        <label class="drawer-label">Account</label>
                        @if (!AuthSession.IsAuthenticated)
                        {
                            <input class="mini-input" @bind="Email" placeholder="email" />
                            <input class="mini-input" @bind="Password" type="password" placeholder="password" />
                            <input class="mini-input mfa-input" @bind="MfaCode" placeholder="mfa (if required)" />
                            <button class="mini-btn" @onclick="SignInAsync" disabled="@Busy">Sign In</button>
                            <button class="mini-btn secondary" @onclick="SignInAsDemoAthleteAsync" disabled="@Busy">Demo Athlete</button>
                            <button class="mini-btn secondary" @onclick="SignInAsDemoCoachAsync" disabled="@Busy">Demo Coach</button>
                        }
                        else
                        {
                            <div class="auth-chip">@AuthSession.Role | @AuthSession.Email</div>
                            <button class="mini-btn secondary" @onclick="SignOutAsync">Sign Out</button>
                        }
                    </section>
                }
                else
                {
                    <div class="drawer-mini-rail">
                        <MudNavMenu Dense="true" Class="drawer-mini-nav">
                            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard" />
                            <MudNavLink Href="/lab" Icon="@Icons.Material.Filled.Psychology" />
                            <MudNavLink Href="/tournaments" Icon="@Icons.Material.Filled.Event" />
                            <MudNavLink Href="/registration" Icon="@Icons.Material.Filled.HowToReg" />
                            <MudNavLink Href="/brackets" Icon="@Icons.Material.Filled.AccountTree" />
                            <MudNavLink Href="/bracket-builder" Icon="@Icons.Material.Filled.AutoFixHigh" />
                            <MudNavLink Href="/table-worker" Icon="@Icons.Material.Filled.TableRestaurant" />
                            <MudNavLink Href="/mat-scoring" Icon="@Icons.Material.Filled.Timer" />
                            <MudNavLink Href="/live" Icon="@Icons.Material.Filled.LiveTv" />
                            <MudNavLink Href="/athlete" Icon="@Icons.Material.Filled.Person" />
                            <MudNavLink Href="/coach" Icon="@Icons.Material.Filled.Groups" />
                            <MudNavLink Href="/recruiting" Icon="@Icons.Material.Filled.School" />
                            <MudNavLink Href="/admin" Icon="@Icons.Material.Filled.AdminPanelSettings" />
                            <MudNavLink Href="/support" Icon="@Icons.Material.Filled.SupportAgent" />
                        </MudNavMenu>
                    </div>
                }
            </div>
        </MudDrawer>

        <MudMainContent>
            @if (!string.IsNullOrWhiteSpace(AuthMessage))
            {
                <div class="auth-message @(AuthOk ? "auth-ok" : "auth-error")">@AuthMessage</div>
            }

            @if (Workflow.TeamId is not null || Workflow.EventId is not null || Workflow.MatchId is not null || Workflow.AthleteProfileId is not null || Workflow.CoachProfileId is not null)
            {
                <div class="workflow-strip">
                    <span class="workflow-chip">Athlete: @Short(Workflow.AthleteProfileId)</span>
                    <span class="workflow-chip">Coach: @Short(Workflow.CoachProfileId)</span>
                    <span class="workflow-chip">Team: @Short(Workflow.TeamId)</span>
                    <span class="workflow-chip">Event: @Short(Workflow.EventId)</span>
                    <span class="workflow-chip">Match: @Short(Workflow.MatchId)</span>
                    <button class="mini-btn ghost" @onclick="ClearWorkflow">Clear Workflow</button>
                </div>
            }

            <main class="surface">
                @Body
            </main>

            <footer class="app-footer">
                <span>Built for K-6, Middle School, High School, and College competition workflows.</span>
            </footer>
        </MudMainContent>
    </MudLayout>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">X</span>
</div>

@code {
    private bool Busy;
    private string Email = "";
    private string Password = "";
    private string MfaCode = "";
    private string? AuthMessage;
    private bool AuthOk;
    private string SearchText = string.Empty;
    private string? SearchStatus;
    private List<GlobalSearchResultItem> SearchResults = [];
    private bool SearchOpen;
    private bool DrawerOpen;
    private Breakpoint CurrentBreakpoint = Breakpoint.Lg;
    private bool CurrentIsMobile => IsMobileBreakpoint(CurrentBreakpoint);
    private bool ShowExpandedDrawerContent => CurrentIsMobile || DrawerOpen;
    private DrawerVariant CurrentDrawerVariant => CurrentIsMobile ? DrawerVariant.Temporary : DrawerVariant.Mini;
    private DrawerClipMode CurrentDrawerClipMode => CurrentIsMobile ? DrawerClipMode.Never : DrawerClipMode.Always;
    private string DrawerToggleIcon => CurrentIsMobile
        ? (DrawerOpen ? Icons.Material.Filled.Close : Icons.Material.Filled.Menu)
        : (DrawerOpen ? Icons.Material.Filled.KeyboardDoubleArrowLeft : Icons.Material.Filled.KeyboardDoubleArrowRight);
    private string DrawerToggleAriaLabel => CurrentIsMobile
        ? (DrawerOpen ? "Close navigation menu" : "Open navigation menu")
        : (DrawerOpen ? "Collapse navigation menu" : "Expand navigation menu");
    private string FullSearchHref => $"/search?q={Uri.EscapeDataString(SearchText.Trim())}";

    protected override void OnInitialized()
    {
        DrawerOpen = false;
        Navigation.LocationChanged += OnLocationChanged;
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    private async Task SignInAsync()
    {
        Busy = true;
        AuthMessage = null;

        var result = await ApiClient.LoginAsync(new LoginRequest(Email, Password, MfaCode));
        AuthOk = result.Success;
        AuthMessage = result.Success ? "Signed in." : result.Message;

        if (result.Success)
        {
            Password = string.Empty;
            MfaCode = string.Empty;
            if (CurrentIsMobile)
            {
                DrawerOpen = false;
            }
        }

        Busy = false;
    }

    private async Task SignInAsDemoAthleteAsync()
    {
        Email = "demo.athlete@pinpointarena.local";
        Password = "DemoPass!123";
        await SignInAsync();
    }

    private async Task SignInAsDemoCoachAsync()
    {
        Email = "demo.coach@pinpointarena.local";
        Password = "DemoPass!123";
        await SignInAsync();
    }

    private async Task SignOutAsync()
    {
        await ApiClient.LogoutAsync();
        AuthOk = true;
        AuthMessage = "Signed out.";
        if (CurrentIsMobile)
        {
            DrawerOpen = false;
        }
    }

    private void ToggleDrawer() => DrawerOpen = !DrawerOpen;

    private Task CloseDrawer()
    {
        if (CurrentIsMobile)
        {
            DrawerOpen = false;
        }
        return Task.CompletedTask;
    }

    private async Task OnSearchInputAsync(ChangeEventArgs args)
    {
        SearchText = args.Value?.ToString() ?? string.Empty;
        var trimmed = SearchText.Trim();
        if (trimmed.Length < 2)
        {
            SearchResults = [];
            SearchStatus = trimmed.Length == 0 ? null : "Type at least 2 characters.";
            SearchOpen = trimmed.Length > 0;
            return;
        }

        SearchStatus = "Searching...";
        SearchOpen = true;
        var response = await ApiClient.SearchGlobalAsync(trimmed, 8);
        if (!response.Success || response.Data is null)
        {
            SearchResults = [];
            SearchStatus = response.Message;
            return;
        }

        SearchResults = response.Data.Results ?? [];
        SearchStatus = null;
    }

    private async Task OnSearchKeyDown(KeyboardEventArgs args)
    {
        if (string.Equals(args.Key, "Enter", StringComparison.OrdinalIgnoreCase))
        {
            await RunFullSearchAsync();
        }
    }

    private Task RunFullSearchAsync()
    {
        SearchOpen = false;
        if (CurrentIsMobile)
        {
            DrawerOpen = false;
        }
        Navigation.NavigateTo(FullSearchHref);
        return Task.CompletedTask;
    }

    private Task OnSearchLinkClick()
    {
        SearchOpen = false;
        if (CurrentIsMobile)
        {
            DrawerOpen = false;
        }
        return Task.CompletedTask;
    }

    private void OnSearchResultClick(GlobalSearchResultItem result)
    {
        SearchOpen = false;
        if (CurrentIsMobile)
        {
            DrawerOpen = false;
        }
        ApplyWorkflowFromSearch(result);
    }

    private static string SearchResultHref(GlobalSearchResultItem result) => result.Type switch
    {
        GlobalSearchEntityType.Match => $"/mat-scoring?matchId={result.Id:D}",
        GlobalSearchEntityType.Tournament => $"/events/{result.Id:D}",
        GlobalSearchEntityType.Athlete => "/athlete",
        GlobalSearchEntityType.Coach => "/coach",
        GlobalSearchEntityType.Stream => "/live",
        GlobalSearchEntityType.Team => "/coach",
        _ => "/search"
    };

    private void ApplyWorkflowFromSearch(GlobalSearchResultItem result)
    {
        switch (result.Type)
        {
            case GlobalSearchEntityType.Athlete:
                Workflow.AthleteProfileId = result.Id;
                break;
            case GlobalSearchEntityType.Tournament:
                Workflow.EventId = result.Id;
                break;
            case GlobalSearchEntityType.Match:
                Workflow.MatchId = result.Id;
                break;
            case GlobalSearchEntityType.Team:
                Workflow.TeamId = result.Id;
                break;
            case GlobalSearchEntityType.Coach:
                Workflow.CoachProfileId = result.Id;
                break;
        }
    }

    private void CloseSearchMenu()
    {
        SearchOpen = false;
    }

    private void OnBreakpointChanged(Breakpoint breakpoint)
    {
        var wasMobile = CurrentIsMobile;
        CurrentBreakpoint = breakpoint;
        var isMobile = CurrentIsMobile;

        if (wasMobile != isMobile)
        {
            DrawerOpen = false;
        }
    }

    private static bool IsMobileBreakpoint(Breakpoint breakpoint)
    {
        return breakpoint is Breakpoint.Xs or Breakpoint.Sm;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs args)
    {
        SearchOpen = false;
        if (CurrentIsMobile)
        {
            DrawerOpen = false;
        }

        _ = InvokeAsync(StateHasChanged);
    }

    private void ClearWorkflow() => Workflow.Clear();

    private static string Short(Guid? id)
    {
        return id is null ? "-" : id.Value.ToString()[..8];
    }
}
